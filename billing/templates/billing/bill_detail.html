{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Bill #{{ bill.bill_number }} - Ultrasound Clinic{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'billing:bill_list' %}">Bills</a></li>
            <li class="breadcrumb-item active">Bill #{{ bill.bill_number }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice"></i> Bill Details
                    </h5>
                    <span class="badge bg-{{ bill.status|lower }}-subtle text-{{ bill.status|lower }}">
                        {{ bill.get_status_display }}
                    </span>
                </div>
                <div class="card-body">
                    <!-- Patient Info -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Patient Information</h6>
                        <p class="mb-1"><strong>Name:</strong> {{ bill.patient.name }}</p>
                        <p class="mb-0"><strong>Email:</strong> {{ bill.patient.email }}</p>
                    </div>

                    <!-- Bill Items -->
                    <div class="table-responsive mb-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Procedure</th>
                                    <th>Date & Time</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in bill_items %}
                                <tr>
                                    <td>{{ item.service.name }}</td>
                                    <td>{{ item.exam.exam_date }}</td>
                                    <td class="text-end">₱{{ item.amount }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end">₱{{ bill.subtotal }}</td>
                                </tr>
                                {% if bill.discount > 0 %}
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Discount:</strong></td>
                                    <td class="text-end">-₱{{ bill.discount }}</td>
                                </tr>
                                {% endif %}
                                {% if bill.tax > 0 %}
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Tax:</strong></td>
                                    <td class="text-end">₱{{ bill.tax }}</td>
                                </tr>
                                {% endif %}
                                <tr class="table-info">
                                    <td colspan="2" class="text-end"><strong>Total Amount:</strong></td>
                                    <td class="text-end"><strong>₱{{ bill.total_amount }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Bill Details -->
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Bill Date:</strong> {{ bill.bill_date }}</p>
                            <p><strong>Due Date:</strong> {{ bill.due_date }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Bill Number:</strong> {{ bill.bill_number }}</p>
                            <p><strong>Status:</strong> {{ bill.get_status_display }}</p>
                        </div>
                    </div>

                    {% if bill.notes %}
                    <div class="alert alert-secondary mt-3">
                        <h6 class="alert-heading">Notes</h6>
                        <p class="mb-0">{{ bill.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payments Section -->
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-money-bill-wave"></i> Payments
                    </h5>
                </div>
                <div class="card-body">
                    {% if payments %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Method</th>
                                    <th>Reference</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments %}
                                <tr>
                                    <td>{{ payment.payment_date }}</td>
                                    <td>{{ payment.get_payment_method_display }}</td>
                                    <td>{{ payment.reference_number|default:"-" }}</td>
                                    <td class="text-end">₱{{ payment.amount }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total Paid:</strong></td>
                                    <td class="text-end">₱{{ total_paid }}</td>
                                </tr>
                                <tr class="{% if remaining_balance > 0 %}table-warning{% else %}table-success{% endif %}">
                                    <td colspan="3" class="text-end"><strong>Remaining Balance:</strong></td>
                                    <td class="text-end"><strong>₱{{ remaining_balance }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No payments recorded yet.</p>
                    {% endif %}

                    {% if bill.status != 'PAID' and bill.status != 'CANCELLED' %}
                    <hr>
                    <h6>Record New Payment</h6>
                    <form method="post">
                        {% csrf_token %}
                        {{ payment_form|crispy }}
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Payment
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Actions Sidebar -->
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="#" class="btn btn-outline-primary">
                            <i class="fas fa-print"></i> Print Bill
                        </a>
                        <a href="#" class="btn btn-outline-info">
                            <i class="fas fa-envelope"></i> Email Bill
                        </a>
                        {% if bill.status == 'PENDING' or bill.status == 'PARTIAL' %}
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelBillModal">
                            <i class="fas fa-ban"></i> Cancel Bill
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Bill Modal -->
{% if bill.status == 'PENDING' or bill.status == 'PARTIAL' %}
<div class="modal fade" id="cancelBillModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this bill? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <form method="post" action="{% url 'billing:cancel_bill' bill.bill_number %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Cancel Bill</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %} 