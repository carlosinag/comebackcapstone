{% extends 'base.html' %}

{% block title %}Ultrasound Examination Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="text-primary mb-0">Ultrasound Examination Report</h1>
            <small class="text-muted">Case Number: {{ exam.case_number|default:"22-205" }}</small>
        </div>
        <div class="col-auto text-end">
            {% if not exam.bill_item %}
            <a href="{% url 'billing:create_bill' exam.pk %}" class="btn btn-success btn-sm me-2">
                <i class="fas fa-file-invoice-dollar me-2"></i>Create Bill
            </a>
            {% else %}
            <a href="{% url 'billing:bill_detail' exam.bill_item.bill.bill_number %}" class="btn btn-info btn-sm me-2">
                <i class="fas fa-file-invoice-dollar me-2"></i>View Bill
            </a>
            {% endif %}
            <a href="{% url 'download-ultrasound-docx' exam.pk %}" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-download me-2"></i>Download DOCX
            </a>
            <a href="{% url 'exam-update' exam.pk %}" class="btn btn-warning btn-sm me-2">
                <i class="fas fa-edit me-2"></i>Edit Exam
            </a>
            <a href="{% url 'patient-detail' exam.patient.pk %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left me-2"></i>Back to Patient
            </a>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0"><i class="fas fa-file-medical-alt me-2"></i>Examination Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Patient Information</h6>
                    <table class="table table-borderless table-sm">
                        <tbody>
                            <tr>
                                <td class="fw-bold text-end" style="width: 40%;">Name:</td>
                                <td>{{ exam.patient.last_name }}, {{ exam.patient.first_name }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-end">Age:</td>
                                <td>{{ exam.patient.age|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-end">Gender:</td>
                                <td>{{ exam.patient.get_sex_display|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-end">Marital Status:</td>
                                <td>{{ exam.patient.marital_status|default:"N/A" }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Examination Information</h6>
                    <table class="table table-borderless table-sm">
                        <tbody>
                            <tr>
                                <td class="fw-bold text-end" style="width: 40%;">Date:</td>
                                <td>{{ exam.exam_date|date:"F d, Y"|default:"N/A"|upper }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-end">Procedure:</td>
                                <td>{{ exam.procedure_type.name|default:"N/A" }} Ultrasound</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-end">Ward:</td>
                                <td>{{ exam.patient.get_patient_status_display|default:"OPD" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-end">Requesting Physician:</td>
                                <td>N/A</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-12">
                    <h6 class="text-muted mb-3"><i class="fas fa-stethoscope me-2"></i>Radiological Findings</h6>
                    <div class="border-start border-primary border-3 ps-3">
                        <p class="mb-0" style="white-space: pre-line;">{{ exam.findings|default:"No findings recorded." }}</p>
                    </div>
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-12">
                    <h6 class="text-muted mb-3"><i class="fas fa-brain me-2"></i>Impression</h6>
                    <div class="border-start border-success border-3 ps-3">
                        <p class="mb-0" style="white-space: pre-line;">{{ exam.impression|default:"No impression recorded." }}</p>
                    </div>
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-12">
                    <h6 class="text-muted mb-3"><i class="fas fa-images me-2"></i>Ultrasound Images</h6>
                    {% for image in exam.images.all %}
                    <div class="mb-4">
                        <h7 class="fw-bold">{{ image.caption|default:"Ultrasound Image" }}</h7>
                        <div class="row">
                            <div class="col-md-6">
                                <img src="{{ image.image.url }}" class="img-fluid border" alt="Original Image" style="max-height: 400px; width: 100%; object-fit: contain; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-src="{{ image.image.url }}" data-caption="{{ image.caption|default:'Original Ultrasound Image' }}">
                                <p class="text-center mt-2"><small class="text-muted">Original Image</small></p>
                            </div>
                            <div class="col-md-6">
                                {% if image.annotated_image %}
                                <img src="{{ image.annotated_image.url }}" class="img-fluid border" alt="Annotated Image" style="max-height: 400px; width: 100%; object-fit: contain; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-src="{{ image.annotated_image.url }}" data-caption="{{ image.caption|default:'Annotated Ultrasound Image' }}">
                                <p class="text-center mt-2"><small class="text-muted">Annotated Image</small></p>
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center border" style="height: 400px;">
                                    <small class="text-muted">Image not yet annotated</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No images available for this examination.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Ultrasound Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="Ultrasound Image">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var imageModal = document.getElementById('imageModal');
    imageModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var imageSrc = button.getAttribute('data-image-src');
        var caption = button.getAttribute('data-caption');
        var modalImage = document.getElementById('modalImage');
        var modalTitle = document.getElementById('imageModalLabel');
        modalImage.src = imageSrc;
        modalTitle.textContent = caption;
    });
});
</script>

<style>
@media print {
    .btn, .container-fluid > .row:first-child {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    .card-header {
        background: white !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    .table td {
        border: none !important;
        padding: 0.25rem 0 !important;
    }
    .border-start {
        border-left: 3px solid #007bff !important;
    }
}
</style>
{% endblock %}
