{% extends 'base.html' %}

{% block title %}{{ patient.first_name }} {{ patient.last_name }} - Image Annotation{% endblock %}

{% block extra_css %}
<style>
    .annotation-container {
        position: relative;
        margin: 20px 0;
    }
    .canvas-container {
        margin: 0 auto;
        border: 1px solid #ddd;
    }
    .annotation-tools {
        margin-top: 10px;
    }
    .color-picker {
        width: 40px;
        height: 40px;
        padding: 0;
        border: none;
        margin-right: 10px;
    }
    .measurement-field {
        margin-bottom: 10px;
    }
    .measurement-field label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }
    .measurement-field input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .measurement-field input:focus {
        border-color: #0d6efd;
        outline: none;
    }
    .measurement-group {
        border: 1px solid #eee;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    .measurement-group h6 {
        margin-bottom: 15px;
        color: #0d6efd;
    }
    #loading-indicator {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Indicator -->
<div id="loading-indicator">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading image...</p>
    </div>
</div>

<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>Image Annotation - {{ patient.first_name }} {{ patient.last_name }}</h2>
        </div>
        <div class="col text-end">
            <a href="{% url 'patient-detail' patient.pk %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Patient Details
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        {% if specific_image_id %}
                            Annotate Selected Image
                        {% else %}
                            Available Ultrasound Images
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if exams %}
                        {% for exam in exams %}
                            {% if exam.images.exists %}
                            <div class="mb-4">
                                <h6>Exam Date: {{ exam.exam_date }} - {{ exam.procedure_type.name }}</h6>
                                {% for image in exam.images.all %}
                                    {% if not specific_image_id or image.id == specific_image_id %}
                                    <div class="annotation-container border p-3">
                                        <div class="text-center">
                                            <canvas id="canvas-{{ image.id }}" width="800" height="600"></canvas>
                                        </div>
                                        <div class="annotation-tools mt-3">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="card-title mb-0">Procedure Measurements</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="mb-3">
                                                                <label class="form-label">Select Procedure Type:</label>
                                                                <select class="form-select" id="procedure-type-{{ image.id }}" onchange="loadProcedureFields('{{ image.id }}')">
                                                                    <option value="">Select Procedure</option>
                                                                    {% for procedure_type in procedure_types %}
                                                                    <option value="{{ procedure_type.name|lower }}" {% if exam.procedure_type.id == procedure_type.id %}selected{% endif %}>{{ procedure_type.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div id="procedure-fields-{{ image.id }}">
                                                                <!-- Dynamic fields will be loaded here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="card-title mb-0">Annotation Tools</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="btn-group mb-3">
                                                                <button class="btn btn-primary btn-sm" onclick="enableDrawing('{{ image.id }}')">
                                                                    <i class="fas fa-pencil-alt"></i> Draw
                                                                </button>
                                                                <button class="btn btn-info btn-sm" onclick="enableMeasurement('{{ image.id }}')">
                                                                    <i class="fas fa-ruler"></i> Measure
                                                                </button>
                                                                <button class="btn btn-success btn-sm" onclick="saveAnnotations('{{ image.id }}')">
                                                                    <i class="fas fa-save"></i> Save
                                                                </button>
                                                                <button class="btn btn-warning btn-sm" onclick="clearAnnotations('{{ image.id }}')">
                                                                    <i class="fas fa-eraser"></i> Clear
                                                                </button>
                                                                <button class="btn btn-secondary btn-sm" onclick="undoLastAnnotation('{{ image.id }}')">
                                                                    <i class="fas fa-undo"></i> Undo
                                                                </button>
                                                            </div>
                                                            <div id="measurement-summary-{{ image.id }}" class="measurement-summary">
                                                                <!-- Measurement summary will be displayed here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="image-url-{{ image.id }}" value="{{ image.image.url }}">
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-center">No examinations found for this patient.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
    const canvases = {};
    const measurements = {};
    const undoStack = {};
    let isDrawing = false;
    let isMeasuring = false;
    let startPoint = null;

    // Procedure-specific measurement fields
    const procedureFields = {
        pelvic: {
            title: "Pelvic Ultrasound Measurements",
            groups: {
                uterus: {
                    title: "Uterus Measurements",
                    fields: [
                        { id: 'uterus_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'uterus_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'uterus_height', label: 'Height (cm)', type: 'number', step: '0.01' },
                        { id: 'endometrial_thickness', label: 'Endometrial Thickness (mm)', type: 'number', step: '0.01' }
                    ]
                },
                right_ovary: {
                    title: "Right Ovary",
                    fields: [
                        { id: 'right_ovary_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'right_ovary_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'right_ovary_height', label: 'Height (cm)', type: 'number', step: '0.01' },
                        { id: 'right_ovary_location', label: 'Location', type: 'text' }
                    ]
                },
                left_ovary: {
                    title: "Left Ovary",
                    fields: [
                        { id: 'left_ovary_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'left_ovary_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'left_ovary_height', label: 'Height (cm)', type: 'number', step: '0.01' },
                        { id: 'left_ovary_location', label: 'Location', type: 'text' }
                    ]
                }
            }
        },
        abdominal: {
            title: "Abdominal Ultrasound Measurements",
            groups: {
                liver: {
                    title: "Liver",
                    fields: [
                        { id: 'liver_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'liver_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'liver_height', label: 'Height (cm)', type: 'number', step: '0.01' },
                        { id: 'liver_location', label: 'Location', type: 'text' }
                    ]
                },
                gallbladder: {
                    title: "Gallbladder",
                    fields: [
                        { id: 'gallbladder_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'gallbladder_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'gallbladder_location', label: 'Location', type: 'text' }
                    ]
                },
                kidneys: {
                    title: "Kidneys",
                    fields: [
                        { id: 'right_kidney_length', label: 'Right Kidney Length (cm)', type: 'number', step: '0.01' },
                        { id: 'right_kidney_width', label: 'Right Kidney Width (cm)', type: 'number', step: '0.01' },
                        { id: 'right_kidney_height', label: 'Right Kidney Height (cm)', type: 'number', step: '0.01' },
                        { id: 'left_kidney_length', label: 'Left Kidney Length (cm)', type: 'number', step: '0.01' },
                        { id: 'left_kidney_width', label: 'Left Kidney Width (cm)', type: 'number', step: '0.01' },
                        { id: 'left_kidney_height', label: 'Left Kidney Height (cm)', type: 'number', step: '0.01' }
                    ]
                }
            }
        },
        breast: {
            title: "Breast Ultrasound Measurements",
            groups: {
                mass: {
                    title: "Mass Measurements",
                    fields: [
                        { id: 'breast_side', label: 'Breast Side', type: 'select', options: [
                            { value: 'L', label: 'Left' },
                            { value: 'R', label: 'Right' }
                        ]},
                        { id: 'mass_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'mass_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'mass_height', label: 'Height (cm)', type: 'number', step: '0.01' },
                        { id: 'mass_location', label: 'Location (Clock Position)', type: 'text' },
                        { id: 'distance_from_nipple', label: 'Distance from Nipple (cm)', type: 'number', step: '0.01' }
                    ]
                }
            }
        },
        thyroid: {
            title: "Thyroid Ultrasound Measurements",
            groups: {
                right_lobe: {
                    title: "Right Lobe",
                    fields: [
                        { id: 'right_lobe_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'right_lobe_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'right_lobe_height', label: 'Height (cm)', type: 'number', step: '0.01' }
                    ]
                },
                left_lobe: {
                    title: "Left Lobe",
                    fields: [
                        { id: 'left_lobe_length', label: 'Length (cm)', type: 'number', step: '0.01' },
                        { id: 'left_lobe_width', label: 'Width (cm)', type: 'number', step: '0.01' },
                        { id: 'left_lobe_height', label: 'Height (cm)', type: 'number', step: '0.01' }
                    ]
                },
                other: {
                    title: "Other Measurements",
                    fields: [
                        { id: 'isthmus_thickness', label: 'Isthmus Thickness (mm)', type: 'number', step: '0.01' },
                        { id: 'nodule_length', label: 'Nodule Length (mm)', type: 'number', step: '0.01' },
                        { id: 'nodule_width', label: 'Nodule Width (mm)', type: 'number', step: '0.01' },
                        { id: 'nodule_height', label: 'Nodule Height (mm)', type: 'number', step: '0.01' },
                        { id: 'nodule_location', label: 'Nodule Location', type: 'text' }
                    ]
                }
            }
        }
    };

    // Initialize all existing canvases
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        if (!loadingIndicator) {
            console.error('Loading indicator not found');
            return;
        }

        // Initialize all canvases
        {% for exam in exams %}
            {% if exam.images.exists %}
                {% for image in exam.images.all %}
                    try {
                        console.log('Initializing canvas for image {{ image.id }}');
                        initCanvas('{{ image.id }}');
                        loadSavedAnnotations('{{ image.id }}');
                    } catch (error) {
                        console.error('Error initializing canvas for image {{ image.id }}:', error);
                        loadingIndicator.style.display = 'none';
                    }
                {% endfor %}
            {% endif %}
        {% endfor %}

        setupDragAndDrop();
        setupFormSubmission();
    });

    function setupDragAndDrop() {
        const dragDropZone = document.getElementById('dragDropZone');
        const imageInput = document.getElementById('imageInput');
        const selectedFileName = document.querySelector('.selected-file-name');

        imageInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                selectedFileName.textContent = this.files[0].name;
                previewImage(this.files[0]);
            }
        });

        dragDropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#0d6efd';
        });

        dragDropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
        });

        dragDropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                imageInput.files = e.dataTransfer.files;
                selectedFileName.textContent = e.dataTransfer.files[0].name;
                previewImage(e.dataTransfer.files[0]);
            }
        });
    }

    function setupFormSubmission() {
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const imageInput = document.getElementById('imageInput');
            const examSelect = document.getElementById('examSelect');

            if (!imageInput.files || !imageInput.files[0]) {
                alert('Please select an image to upload');
                return;
            }

            if (!examSelect.value) {
                alert('Please select an examination');
                return;
            }

            // Show loading indicator
            document.getElementById('loading-indicator').style.display = 'block';
            
            this.submit();
        });
    }

    function loadSavedAnnotations(imageId) {
        fetch(`/api/exams/${imageId}/annotations/`)
            .then(response => response.json())
            .then(data => {
                if (data.annotations) {
                    const canvas = canvases[imageId];
                    canvas.loadFromJSON(data.annotations, function() {
                        canvas.renderAll();
                        // Restore measurements from saved annotations
                        const objects = canvas.getObjects();
                        measurements[imageId] = {};
                        objects.forEach(obj => {
                            if (obj.type === 'text' && obj.measurementId) {
                                measurements[imageId][obj.measurementId] = obj.text;
                            }
                        });
                        updateMeasurementSummary(imageId);
                    });
                }
            })
            .catch(error => console.error('Error loading annotations:', error));
    }

    function initCanvas(imageId) {
        const loadingIndicator = document.getElementById('loading-indicator');
        const canvasContainer = document.getElementById(`canvas-${imageId}`);
        
        if (!canvasContainer) {
            console.error(`Canvas container not found for image ${imageId}`);
            return;
        }

        loadingIndicator.style.display = 'block';

        // Dispose of existing canvas if it exists
        if (canvases[imageId]) {
            canvases[imageId].dispose();
        }

        const canvas = new fabric.Canvas(`canvas-${imageId}`, {
            selection: true,
            preserveObjectStacking: true,
            isDrawingMode: false
        });
        
        canvases[imageId] = canvas;
        measurements[imageId] = {};
        undoStack[imageId] = [];
        
        // Load the ultrasound image
        const imageUrl = document.getElementById(`image-url-${imageId}`).value;
        
        fabric.Image.fromURL(imageUrl, function(img) {
            if (!img) {
                console.error(`Failed to load image for ${imageId}`);
                loadingIndicator.style.display = 'none';
                return;
            }

            const scale = Math.min(
                canvas.width / img.width,
                canvas.height / img.height
            );
            
            img.scale(scale);
            canvas.setBackgroundImage(img, function() {
                canvas.renderAll();
                loadingIndicator.style.display = 'none';
            }, {
                originX: 'center',
                originY: 'center',
                left: canvas.width / 2,
                top: canvas.height / 2
            });
        }, null, {
            crossOrigin: 'anonymous'
        });

        // Set up drawing brush
        canvas.freeDrawingBrush.width = 2;
        canvas.freeDrawingBrush.color = '#ff0000';

        // Mouse down event
        canvas.on('mouse:down', function(options) {
            if (isMeasuring) {
                startPoint = canvas.getPointer(options.e);
                const circle = new fabric.Circle({
                    radius: 3,
                    fill: '#ff0000',
                    left: startPoint.x,
                    top: startPoint.y,
                    selectable: false
                });
                canvas.add(circle);
            }
        });

        // Mouse move event
        canvas.on('mouse:move', function(options) {
            if (isMeasuring && startPoint) {
                const currentPoint = canvas.getPointer(options.e);
                if (canvas.getObjects().length > 0) {
                    const line = canvas.getObjects()[canvas.getObjects().length - 1];
                    if (line && line.type === 'line') {
                        canvas.remove(line);
                    }
                }
                const line = new fabric.Line([
                    startPoint.x,
                    startPoint.y,
                    currentPoint.x,
                    currentPoint.y
                ], {
                    stroke: '#ff0000',
                    strokeWidth: 2,
                    selectable: false
                });
                canvas.add(line);
                canvas.renderAll();
            }
        });

        // Mouse up event
        canvas.on('mouse:up', function(options) {
            if (isMeasuring && startPoint) {
                const endPoint = canvas.getPointer(options.e);
                const distance = Math.sqrt(
                    Math.pow(endPoint.x - startPoint.x, 2) +
                    Math.pow(endPoint.y - startPoint.y, 2)
                );
                
                const measurementId = `measurement_${Date.now()}`;
                const text = new fabric.Text(
                    `${Math.round(distance)}px`,
                    {
                        left: (startPoint.x + endPoint.x) / 2,
                        top: (startPoint.y + endPoint.y) / 2,
                        fontSize: 14,
                        fill: '#ff0000',
                        selectable: true,
                        measurementId: measurementId
                    }
                );
                canvas.add(text);
                
                // Store measurement
                measurements[imageId][measurementId] = `${Math.round(distance)}px`;
                
                // Add end point circle
                const circle = new fabric.Circle({
                    radius: 3,
                    fill: '#ff0000',
                    left: endPoint.x,
                    top: endPoint.y,
                    selectable: false
                });
                canvas.add(circle);
                
                startPoint = null;
                saveToUndoStack(imageId);
                updateMeasurementSummary(imageId);
            }
        });

        return canvas;
    }

    function loadProcedureFields(imageId) {
        const procedureType = document.getElementById(`procedure-type-${imageId}`).value;
        const fieldsContainer = document.getElementById(`procedure-fields-${imageId}`);
        const procedureConfig = procedureFields[procedureType];
        
        if (!procedureConfig) {
            fieldsContainer.innerHTML = '';
            return;
        }

        let html = `<h6 class="mb-4">${procedureConfig.title}</h6>`;
        
        // Generate HTML for each group
        for (const [groupKey, group] of Object.entries(procedureConfig.groups)) {
            html += `
                <div class="measurement-group">
                    <h6>${group.title}</h6>
            `;
            
            // Generate fields for this group
            group.fields.forEach(field => {
                html += `
                    <div class="measurement-field">
                        <label for="${field.id}-${imageId}">${field.label}:</label>
                `;
                
                if (field.type === 'select') {
                    html += `
                        <select class="form-select" id="${field.id}-${imageId}" 
                                onchange="updateMeasurement('${imageId}', '${field.id}', this.value)">
                            <option value="">Select ${field.label}</option>
                    `;
                    field.options.forEach(option => {
                        html += `<option value="${option.value}">${option.label}</option>`;
                    });
                    html += `</select>`;
                } else {
                    html += `
                        <input type="${field.type}" 
                               class="form-control" 
                               id="${field.id}-${imageId}"
                               step="${field.step || '1'}"
                               onchange="updateMeasurement('${imageId}', '${field.id}', this.value)">
                    `;
                }
                
                html += `</div>`;
            });
            
            html += `</div>`;
        }
        
        fieldsContainer.innerHTML = html;
        
        // Load saved measurements if they exist
        loadSavedMeasurements(imageId, procedureType);
    }

    function loadSavedMeasurements(imageId, procedureType) {
        fetch(`/api/exams/${imageId}/measurements/?type=${procedureType}`)
            .then(response => response.json())
            .then(data => {
                if (data.measurements) {
                    Object.entries(data.measurements).forEach(([key, value]) => {
                        const input = document.getElementById(`${key}-${imageId}`);
                        if (input) {
                            input.value = value;
                        }
                    });
                }
            })
            .catch(error => console.error('Error loading measurements:', error));
    }

    function updateMeasurement(imageId, fieldId, value) {
        if (!measurements[imageId]) {
            measurements[imageId] = {};
        }
        measurements[imageId][fieldId] = value;
        updateMeasurementSummary(imageId);
    }

    function updateMeasurementSummary(imageId) {
        const summaryContainer = document.getElementById(`measurement-summary-${imageId}`);
        const procedureType = document.getElementById(`procedure-type-${imageId}`).value;
        
        if (!procedureType || !measurements[imageId]) {
            summaryContainer.innerHTML = '';
            return;
        }

        const procedureConfig = procedureFields[procedureType];
        let html = `<h6 class="mt-3 mb-3">Measurement Summary</h6><div class="table-responsive"><table class="table table-sm">`;
        
        Object.entries(procedureConfig.groups).forEach(([groupKey, group]) => {
            html += `
                <tr class="table-primary">
                    <th colspan="2">${group.title}</th>
                </tr>
            `;
            
            group.fields.forEach(field => {
                const value = measurements[imageId][field.id];
                if (value) {
                    html += `
                        <tr>
                            <td>${field.label}</td>
                            <td>${value} ${field.type === 'number' ? (field.label.includes('mm') ? 'mm' : 'cm') : ''}</td>
                        </tr>
                    `;
                }
            });
        });
        
        html += '</table></div>';
        summaryContainer.innerHTML = html;
    }

    function clearAnnotations(imageId) {
        const canvas = canvases[imageId];
        canvas.getObjects().forEach(obj => canvas.remove(obj));
        canvas.renderAll();
        
        // Clear measurements
        measurements[imageId] = {};
        undoStack[imageId] = [];
        
        // Clear input fields
        const procedureType = document.getElementById(`procedure-type-${imageId}`).value;
        const fields = procedureFields[procedureType]?.groups[procedureType]?.fields || [];
        fields.forEach(field => {
            const input = document.getElementById(`${field.id}-${imageId}`);
            if (input) input.value = '';
        });
        
        updateMeasurementSummary(imageId);
    }

    function saveToUndoStack(imageId) {
        const canvas = canvases[imageId];
        undoStack[imageId].push({
            canvas: JSON.stringify(canvas.toJSON()),
            measurements: JSON.parse(JSON.stringify(measurements[imageId]))
        });
    }

    function undoLastAnnotation(imageId) {
        if (undoStack[imageId].length > 0) {
            const canvas = canvases[imageId];
            const lastState = undoStack[imageId].pop();
            
            canvas.loadFromJSON(JSON.parse(lastState.canvas), function() {
                canvas.renderAll();
                measurements[imageId] = lastState.measurements;
                updateMeasurementSummary(imageId);
            });
        }
    }

    function enableDrawing(imageId) {
        const canvas = canvases[imageId];
        isDrawing = true;
        isMeasuring = false;
        canvas.isDrawingMode = true;
        canvas.freeDrawingBrush.width = 2;
        canvas.freeDrawingBrush.color = '#ff0000';
    }

    function enableMeasurement(imageId) {
        const canvas = canvases[imageId];
        isDrawing = false;
        isMeasuring = true;
        canvas.isDrawingMode = false;
    }

    function saveAnnotations(imageId) {
        const canvas = canvases[imageId];
        const procedureType = document.getElementById(`procedure-type-${imageId}`).value;
        
        if (!procedureType) {
            alert('Please select a procedure type before saving.');
            return;
        }
        
        // Collect all measurements for the current procedure
        const measurementData = {};
        const procedureConfig = procedureFields[procedureType];
        
        Object.values(procedureConfig.groups).forEach(group => {
            group.fields.forEach(field => {
                const input = document.getElementById(`${field.id}-${imageId}`);
                if (input && input.value) {
                    measurementData[field.id] = input.value;
                }
            });
        });
        
        const data = {
            annotations: canvas.toJSON(['measurementId']),
            measurements: measurementData,
            procedure_type: procedureType
        };
        
        fetch(`/api/exams/${imageId}/annotations/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Annotations and measurements saved successfully!');
                updateMeasurementSummary(imageId);
            } else {
                alert('Error saving annotations and measurements');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving annotations and measurements');
        });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %} 