{% extends 'base.html' %}

{% block title %}{{ patient.name }} - Image Annotation{% endblock %}

{% block extra_css %}
<style>
    .annotation-container {
        position: relative;
        margin: 20px 0;
    }
    .canvas-container {
        margin: 0 auto;
    }
    .annotation-tools {
        margin-top: 10px;
    }
    .color-picker {
        width: 40px;
        height: 40px;
        padding: 0;
        border: none;
        margin-right: 10px;
    }
    .upload-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .drag-drop-zone {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }
    .drag-drop-zone:hover {
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>Image Annotation - {{ patient.name }}</h2>
        </div>
        <div class="col text-end">
            <a href="{% url 'patient-detail' patient.pk %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Patient Details
            </a>
        </div>
    </div>

    <!-- Image Upload Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upload New Ultrasound Image</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" action="{% url 'exam-image-upload' patient.pk %}" id="uploadForm">
                        {% csrf_token %}
                        <div class="upload-section">
                            <div class="drag-drop-zone" id="dragDropZone">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                <h5>Drag and drop your ultrasound image here</h5>
                                <p class="text-muted">or</p>
                                <input type="file" name="image" id="imageInput" class="d-none" accept="image/*">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                                    <i class="fas fa-file-upload me-2"></i>Choose File
                                </button>
                                <p class="mt-2 selected-file-name"></p>
                            </div>
                            <div class="mt-3">
                                <label for="examSelect" class="form-label">Select Examination:</label>
                                <select name="exam_id" id="examSelect" class="form-select" required>
                                    <option value="">Select an examination</option>
                                    {% for exam in exams %}
                                        <option value="{{ exam.id }}">{{ exam.exam_date }} - {{ exam.get_procedure_type_display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="text-end mt-3">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Upload Image
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Available Ultrasound Images</h5>
                </div>
                <div class="card-body">
                    {% if exams %}
                        {% for exam in exams %}
                            <div class="mb-4">
                                <h6>Exam Date: {{ exam.exam_date }}</h6>
                                <div class="annotation-container border p-3">
                                    {% if exam.image %}
                                        <div class="text-center">
                                            <canvas id="canvas-{{ exam.id }}" width="800" height="600"></canvas>
                                        </div>
                                        <div class="annotation-tools mt-3">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="card-title mb-0">Procedure Measurements</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="mb-3">
                                                                <label class="form-label">Select Procedure Type:</label>
                                                                <select class="form-select" id="procedure-type-{{ exam.id }}" onchange="loadProcedureFields('{{ exam.id }}')">
                                                                    <option value="">Select Procedure</option>
                                                                    <option value="pelvic">Pelvic Ultrasound</option>
                                                                    <option value="abdominal">Abdominal Ultrasound</option>
                                                                    <option value="breast">Breast Ultrasound</option>
                                                                    <option value="thyroid">Thyroid Ultrasound</option>
                                                                </select>
                                                            </div>
                                                            <div id="procedure-fields-{{ exam.id }}">
                                                                <!-- Dynamic fields will be loaded here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="card-title mb-0">Annotation Preview</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="btn-group mb-3">
                                                                <button class="btn btn-success btn-sm" onclick="saveAnnotations('{{ exam.id }}')">
                                                                    <i class="fas fa-save"></i> Save Measurements
                                                                </button>
                                                                <button class="btn btn-warning btn-sm" onclick="clearAnnotations('{{ exam.id }}')">
                                                                    <i class="fas fa-eraser"></i> Clear
                                                                </button>
                                                                <button class="btn btn-secondary btn-sm" onclick="undoLastAnnotation('{{ exam.id }}')">
                                                                    <i class="fas fa-undo"></i> Undo
                                                                </button>
                                                            </div>
                                                            <div id="measurement-summary-{{ exam.id }}" class="measurement-summary">
                                                                <!-- Measurement summary will be displayed here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="image-url-{{ exam.id }}" value="{{ exam.image.url }}">
                                    {% else %}
                                        <p class="text-muted">No image available for this exam.</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center">No examinations found for this patient.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
    const canvases = {};
    const measurements = {};
    const undoStack = {};

    // Procedure-specific measurement fields
    const procedureFields = {
        pelvic: [
            { id: 'uterus_length', label: 'Uterus Length (cm)', type: 'measurement' },
            { id: 'uterus_width', label: 'Uterus Width (cm)', type: 'measurement' },
            { id: 'endometrial_thickness', label: 'Endometrial Thickness (mm)', type: 'measurement' },
            { id: 'right_ovary_location', label: 'Right Ovary Location', type: 'location' },
            { id: 'left_ovary_location', label: 'Left Ovary Location', type: 'location' }
        ],
        abdominal: [
            { id: 'liver_size', label: 'Liver Size (cm)', type: 'measurement' },
            { id: 'liver_location', label: 'Liver Location', type: 'location' },
            { id: 'gallbladder_location', label: 'Gallbladder Location', type: 'location' },
            { id: 'spleen_size', label: 'Spleen Size (cm)', type: 'measurement' },
            { id: 'kidney_right_size', label: 'Right Kidney Size (cm)', type: 'measurement' },
            { id: 'kidney_left_size', label: 'Left Kidney Size (cm)', type: 'measurement' }
        ],
        breast: [
            { id: 'mass_location', label: 'Mass Location', type: 'location' },
            { id: 'mass_size', label: 'Mass Size (cm)', type: 'measurement' },
            { id: 'distance_from_nipple', label: 'Distance from Nipple (cm)', type: 'measurement' }
        ],
        thyroid: [
            { id: 'right_lobe_size', label: 'Right Lobe Size (cm)', type: 'measurement' },
            { id: 'left_lobe_size', label: 'Left Lobe Size (cm)', type: 'measurement' },
            { id: 'nodule_location', label: 'Nodule Location', type: 'location' },
            { id: 'nodule_size', label: 'Nodule Size (mm)', type: 'measurement' }
        ]
    };

    document.addEventListener('DOMContentLoaded', function() {
        {% for exam in exams %}
            {% if exam.image %}
                initCanvas('{{ exam.id }}');
            {% endif %}
        {% endfor %}

        const dragDropZone = document.getElementById('dragDropZone');
        const imageInput = document.getElementById('imageInput');
        const selectedFileName = document.querySelector('.selected-file-name');

        // Handle file selection
        imageInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                selectedFileName.textContent = this.files[0].name;
            }
        });

        // Handle drag and drop
        dragDropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#0d6efd';
        });

        dragDropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
        });

        dragDropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                imageInput.files = e.dataTransfer.files;
                selectedFileName.textContent = e.dataTransfer.files[0].name;
            }
        });

        // Form submission handling
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!imageInput.files || !imageInput.files[0]) {
                alert('Please select an image to upload');
                return;
            }

            const examId = document.getElementById('examSelect').value;
            if (!examId) {
                alert('Please select an examination');
                return;
            }

            this.submit();
        });
    });

    function initCanvas(examId) {
        const canvas = new fabric.Canvas(`canvas-${examId}`);
        canvases[examId] = canvas;
        measurements[examId] = {};
        undoStack[examId] = [];
        
        // Load the ultrasound image
        const imageUrl = document.getElementById(`image-url-${examId}`).value;
        fabric.Image.fromURL(imageUrl, function(img) {
            const scale = Math.min(800 / img.width, 600 / img.height);
            img.scale(scale);
            
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                originX: 'center',
                originY: 'center',
                left: canvas.width / 2,
                top: canvas.height / 2
            });
        });

        // Enable object selection
        canvas.on('mouse:down', function(options) {
            if (options.target) {
                updateMeasurementSummary(examId);
            }
        });
    }

    function loadProcedureFields(examId) {
        const procedureType = document.getElementById(`procedure-type-${examId}`).value;
        const fieldsContainer = document.getElementById(`procedure-fields-${examId}`);
        const fields = procedureFields[procedureType] || [];
        
        let html = '';
        fields.forEach(field => {
            html += `
                <div class="mb-3">
                    <label class="form-label">${field.label}:</label>
                    ${field.type === 'location' ? `
                        <div class="input-group">
                            <input type="text" class="form-control" id="${field.id}-${examId}" placeholder="Click on image to set location">
                            <button class="btn btn-outline-primary" onclick="startLocationSelection('${examId}', '${field.id}')">
                                Set Location
                            </button>
                        </div>
                    ` : `
                        <input type="number" class="form-control" id="${field.id}-${examId}" 
                               onchange="updateMeasurement('${examId}', '${field.id}', this.value)">
                    `}
                </div>
            `;
        });
        
        fieldsContainer.innerHTML = html;
        clearAnnotations(examId);
    }

    function startLocationSelection(examId, fieldId) {
        const canvas = canvases[examId];
        const input = document.getElementById(`${fieldId}-${examId}`);
        
        canvas.on('mouse:down', function handler(options) {
            const pointer = canvas.getPointer(options.e);
            addLocationMarker(examId, fieldId, pointer.x, pointer.y);
            input.value = `X: ${Math.round(pointer.x)}, Y: ${Math.round(pointer.y)}`;
            canvas.off('mouse:down', handler);
            updateMeasurementSummary(examId);
        });
    }

    function addLocationMarker(examId, fieldId, x, y) {
        const canvas = canvases[examId];
        const circle = new fabric.Circle({
            left: x - 5,
            top: y - 5,
            radius: 5,
            fill: 'red',
            stroke: 'white',
            strokeWidth: 2
        });
        
        const label = new fabric.Text(fieldId.replace(/_/g, ' '), {
            left: x + 10,
            top: y - 10,
            fontSize: 14,
            fill: 'red'
        });
        
        const group = new fabric.Group([circle, label], {
            id: fieldId
        });
        
        // Remove existing marker for this field if it exists
        const existingObjects = canvas.getObjects().filter(obj => obj.id === fieldId);
        existingObjects.forEach(obj => canvas.remove(obj));
        
        canvas.add(group);
        canvas.renderAll();
        saveToUndoStack(examId);
    }

    function updateMeasurement(examId, fieldId, value) {
        measurements[examId][fieldId] = value;
        updateMeasurementSummary(examId);
    }

    function updateMeasurementSummary(examId) {
        const procedureType = document.getElementById(`procedure-type-${examId}`).value;
        const summaryContainer = document.getElementById(`measurement-summary-${examId}`);
        const fields = procedureFields[procedureType] || [];
        
        let html = '<h6>Measurements Summary:</h6><ul class="list-unstyled">';
        fields.forEach(field => {
            const value = document.getElementById(`${field.id}-${examId}`).value;
            if (value) {
                html += `<li><strong>${field.label}:</strong> ${value}</li>`;
            }
        });
        html += '</ul>';
        
        summaryContainer.innerHTML = html;
    }

    function clearAnnotations(examId) {
        const canvas = canvases[examId];
        canvas.getObjects().forEach(obj => canvas.remove(obj));
        canvas.renderAll();
        
        // Clear measurements
        measurements[examId] = {};
        undoStack[examId] = [];
        
        // Clear input fields
        const procedureType = document.getElementById(`procedure-type-${examId}`).value;
        const fields = procedureFields[procedureType] || [];
        fields.forEach(field => {
            const input = document.getElementById(`${field.id}-${examId}`);
            if (input) input.value = '';
        });
        
        updateMeasurementSummary(examId);
    }

    function saveToUndoStack(examId) {
        const canvas = canvases[examId];
        undoStack[examId].push({
            canvas: JSON.stringify(canvas.toJSON(['id'])),
            measurements: JSON.parse(JSON.stringify(measurements[examId]))
        });
    }

    function undoLastAnnotation(examId) {
        if (undoStack[examId].length > 0) {
            const previousState = undoStack[examId].pop();
            const canvas = canvases[examId];
            
            canvas.loadFromJSON(JSON.parse(previousState.canvas), function() {
                canvas.renderAll();
                measurements[examId] = previousState.measurements;
                updateMeasurementSummary(examId);
            });
        }
    }

    async function saveAnnotations(examId) {
        const canvas = canvases[examId];
        const procedureType = document.getElementById(`procedure-type-${examId}`).value;
        
        const data = {
            procedure_type: procedureType,
            measurements: measurements[examId],
            annotations: canvas.toJSON(['id'])
        };
        
        try {
            const response = await fetch(`/api/exams/${examId}/annotations/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Measurements and annotations saved successfully!');
            } else {
                alert('Error saving measurements and annotations');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving measurements and annotations');
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %} 