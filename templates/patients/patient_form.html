{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Patient{% else %}New Patient{% endif %}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        {% if form.instance.pk %}
                            Edit Patient Information
                        {% else %}
                            New Patient Registration
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <!-- Personal Information -->
                        <h4 class="mb-3">Personal Information</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }}</label>
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                        <div class="text-danger">{{ form.first_name.errors.0 }}</div>
                                    {% endif %}
                                    {% if form.first_name.help_text %}
                                        <small class="form-text text-muted">{{ form.first_name.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                        <div class="text-danger">{{ form.last_name.errors.0 }}</div>
                                    {% endif %}
                                    {% if form.last_name.help_text %}
                                        <small class="form-text text-muted">{{ form.last_name.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.birthday.id_for_label }}" class="form-label">Birthday</label>
                                    {{ form.birthday }}
                                    {% if form.birthday.errors %}
                                        <div class="text-danger">{{ form.birthday.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="calculated_age" class="form-label">Age</label>
                                    <input type="text" id="calculated_age" class="form-control" readonly>
                                </div>
                            </div> -->
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.sex.id_for_label }}" class="form-label">{{ form.sex.label }}</label>
                                    {{ form.sex }}
                                    {% if form.sex.errors %}
                                        <div class="text-danger">{{ form.sex.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.marital_status.id_for_label }}" class="form-label">Marital Status</label>
                                    {{ form.marital_status }}
                                    {% if form.marital_status.errors %}
                                        <div class="text-danger">{{ form.marital_status.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.patient_type.id_for_label }}" class="form-label">Patient Type</label>
                                    {{ form.patient_type }}
                                    {% if form.patient_type.errors %}
                                        <div class="text-danger">{{ form.patient_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="mb-3" id="id_number_container" style="display: none;">
                                    <label for="{{ form.id_number.id_for_label }}" class="form-label">Senior Citizen/PWD ID Number</label>
                                    {{ form.id_number }}
                                    {% if form.id_number.help_text %}
                                        <div class="form-text">{{ form.id_number.help_text }}</div>
                                    {% endif %}
                                    {% if form.id_number.errors %}
                                        <div class="text-danger">{{ form.id_number.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.patient_status.id_for_label }}" class="form-label">Patient Status</label>
                                    {{ form.patient_status }}
                                    {% if form.patient_status.errors %}
                                        <div class="text-danger">{{ form.patient_status.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Address Information -->
                        <h4 class="mb-3 mt-4">Address Information</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.region.id_for_label }}" class="form-label">Region</label>
                                    {{ form.region }}
                                    {% if form.region.errors %}
                                        <div class="text-danger">{{ form.region.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.province.id_for_label }}" class="form-label">Province</label>
                                    {{ form.province }}
                                    {% if form.province.errors %}
                                        <div class="text-danger">{{ form.province.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.city.id_for_label }}" class="form-label">City/Municipality</label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <div class="text-danger">{{ form.city.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.barangay.id_for_label }}" class="form-label">Barangay</label>
                                    {{ form.barangay }}
                                    {% if form.barangay.errors %}
                                        <div class="text-danger">{{ form.barangay.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.street_address.id_for_label }}" class="form-label">Street Address</label>
                            {{ form.street_address }}
                            {% if form.street_address.help_text %}
                                <div class="form-text">{{ form.street_address.help_text }}</div>
                            {% endif %}
                            {% if form.street_address.errors %}
                                <div class="text-danger">{{ form.street_address.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Contact Information -->
                        <h4 class="mb-3 mt-4">Contact Information</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.contact_number.id_for_label }}" class="form-label">{{ form.contact_number.label }}</label>
                                    {% render_field form.contact_number type="tel" inputmode="numeric" maxlength="11" pattern="\d*" id="id_contact_number"%}
                                    {% if form.contact_number.errors %}
                                        <div class="text-danger">{{ form.contact_number.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                                    {{ form.email }}
                                    <div class="text-danger" id="email-error">{{ form.email.errors.0 }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'patient-list' %}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                {% if form.instance.pk %}
                                    Update Patient
                                {% else %}
                                    Register Patient
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const el = document.getElementById('id_contact_number');
  if (!el) return;
  el.addEventListener('input', function () {
    this.value = this.value.replace(/[^0-9]/g, '');
  });
});
document.addEventListener('DOMContentLoaded', function() {
    const regionSelect = document.getElementById('id_region');
    const provinceSelect = document.getElementById('id_province');
    const citySelect = document.getElementById('id_city');
    const barangaySelect = document.getElementById('id_barangay');
    const patientTypeSelect = document.getElementById('id_patient_type');
    const idNumberContainer = document.getElementById('id_number_container');

    console.log('Form elements:', {
        regionSelect,
        provinceSelect,
        citySelect,
        barangaySelect,
        patientTypeSelect,
        idNumberContainer
    });

    // Function to toggle ID number field visibility with animation
    function toggleIdNumberField() {
        const selectedType = patientTypeSelect.value;
        if (selectedType === 'SENIOR' || selectedType === 'PWD') {
            idNumberContainer.style.display = 'block';
            idNumberContainer.style.opacity = '0';
            setTimeout(() => {
                idNumberContainer.style.opacity = '1';
                idNumberContainer.style.transition = 'opacity 0.3s ease-in';
            }, 50);
            idNumberContainer.querySelector('input').required = true;
        } else {
            idNumberContainer.style.opacity = '0';
            idNumberContainer.style.transition = 'opacity 0.3s ease-out';
            setTimeout(() => {
                idNumberContainer.style.display = 'none';
                idNumberContainer.querySelector('input').required = false;
                idNumberContainer.querySelector('input').value = '';
            }, 300);
        }
    }

    // Add event listener for patient type changes
    patientTypeSelect.addEventListener('change', toggleIdNumberField);

    // Call the function initially to set the correct state
    toggleIdNumberField();

    // Function to update select options
    function updateSelect(selectElement, data, defaultOption = 'Select...') {
        console.log('Updating select element:', selectElement.id, 'with data:', data);
        const currentValue = selectElement.getAttribute('value') || selectElement.value; // Preserve current value from POST data
        selectElement.innerHTML = `<option value="">${defaultOption}</option>`;
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.code || item.province_code || item.city_code || item.brgy_code;
            option.textContent = item.name || item.province_name || item.city_name || item.brgy_name;
            selectElement.appendChild(option);
        });
        // Restore the current value if it exists in the new options, or add it if not found
        if (currentValue) {
            if (selectElement.querySelector(`option[value="${currentValue}"]`)) {
                selectElement.value = currentValue;
            } else {
                // Add the current value as an option to preserve it
                const preservedOption = document.createElement('option');
                preservedOption.value = currentValue;
                preservedOption.textContent = `Previously selected (${currentValue})`;
                selectElement.appendChild(preservedOption);
                selectElement.value = currentValue;
            }
        }
        selectElement.disabled = false;
    }

    // Function to pad the code with leading zeros
    function padWithZeros(code) {
        // Ensure the code is a string and pad it to 4 digits
        return code.toString().padStart(4, '0');
    }

    // Function to fetch JSON data
    async function fetchJsonData(path) {
        try {
            const response = await fetch(path);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    // Function to handle loading state
    function setLoadingState(selectElement) {
        selectElement.disabled = true;
        selectElement.innerHTML = '<option value="">Loading...</option>';
    }

    // Function to handle error state
    function setErrorState(selectElement, error) {
        selectElement.disabled = true;
        selectElement.innerHTML = `<option value="">Error: ${error}</option>`;
    }

    // Function to reset dependent fields
    function resetDependentFields(startFrom) {
        if (startFrom === 'province' || startFrom === 'all') {
            provinceSelect.innerHTML = '<option value="">Select Province...</option>';
            provinceSelect.disabled = true;
        }
        if (startFrom === 'city' || startFrom === 'all') {
            citySelect.innerHTML = '<option value="">Select City/Municipality...</option>';
            citySelect.disabled = true;
        }
        if (startFrom === 'barangay' || startFrom === 'all') {
            barangaySelect.innerHTML = '<option value="">Select Barangay...</option>';
            barangaySelect.disabled = true;
        }
    }

    // Function to load initial regions
    async function loadInitialRegions() {
        setLoadingState(regionSelect);
        try {
            console.log('Fetching regions from:', "{% static 'philippine-addresses/region.json' %}");
            const response = await fetch("{% static 'philippine-addresses/region.json' %}");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const regions = await response.json();
            console.log('Loaded regions:', regions);
            
            if (regions && regions.length > 0) {
                updateSelect(regionSelect, regions.map(region => ({
                    code: region.region_code,
                    name: region.region_name
                })), 'Select Region...');
                console.log('Successfully updated region select');
            } else {
                throw new Error('No regions found in the data');
            }
        } catch (error) {
            console.error('Error loading regions:', error);
            setErrorState(regionSelect, 'Failed to load regions: ' + error.message);
        }
    }

    // Function to populate address fields based on current values (for editing/invalid forms)
    async function populateAddressFields() {
        if (!regionSelect.value) return;

        try {
            // Load provinces for selected region
            const selectedRegionCode = regionSelect.value.toString().padStart(2, '0');
            const provinceResponse = await fetch("{% static 'philippine-addresses/province.json' %}");
            const provinces = await provinceResponse.json();
            const filteredProvinces = provinces.filter(p => p.region_code === selectedRegionCode);
            updateSelect(provinceSelect, filteredProvinces.map(p => ({
                code: p.province_code,
                name: p.province_name
            })), 'Select Province...');

            if (provinceSelect.value) {
                // Load cities for selected province
                const selectedProvinceCode = provinceSelect.value;
                const cityResponse = await fetch("{% static 'philippine-addresses/city.json' %}");
                const cities = await cityResponse.json();
                const filteredCities = cities.filter(c => c.province_code === selectedProvinceCode);
                updateSelect(citySelect, filteredCities.map(c => ({
                    code: c.city_code,
                    name: c.city_name
                })), 'Select City/Municipality...');

                if (citySelect.value) {
                    // Load barangays for selected city
                    const selectedCityCode = citySelect.value;
                    const barangayResponse = await fetch("{% static 'philippine-addresses/barangay.json' %}");
                    const barangays = await barangayResponse.json();
                    const filteredBarangays = barangays.filter(b => b.city_code === selectedCityCode);
                    updateSelect(barangaySelect, filteredBarangays.map(b => ({
                        code: b.brgy_code,
                        name: b.brgy_name
                    })), 'Select Barangay...');
                }
            }
        } catch (error) {
            console.error('Error populating address fields:', error);
        }
    }

    // Load regions when page loads
    console.log('Starting initial region load...');
    loadInitialRegions().then(() => {
        // After regions are loaded, populate dependent fields if values exist
        populateAddressFields().catch(error => console.error('Error populating address fields:', error));
    }).catch(error => {
        console.error('Failed to load initial regions:', error);
    });

    // Region change handler
    regionSelect.addEventListener('change', async function() {
        console.log('Region selected:', this.value);
        resetDependentFields('all');

        if (!this.value) {
            return;
        }

        setLoadingState(provinceSelect);
        try {
            console.log('Fetching provinces from:', "{% static 'philippine-addresses/province.json' %}");
            const response = await fetch("{% static 'philippine-addresses/province.json' %}");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const provinces = await response.json();
            console.log('All provinces:', provinces);

            // Ensure we're comparing strings
            const selectedRegionCode = this.value.toString().padStart(2, '0');
            console.log('Looking for provinces with region_code:', selectedRegionCode);

            const filteredProvinces = provinces.filter(province =>
                province.region_code === selectedRegionCode
            );
            console.log('Filtered provinces:', filteredProvinces);

            if (filteredProvinces.length > 0) {
                updateSelect(provinceSelect, filteredProvinces.map(province => ({
                    code: province.province_code,
                    name: province.province_name
                })), 'Select Province...');
            } else {
                setErrorState(provinceSelect, 'No provinces found for this region');
            }
        } catch (error) {
            console.error('Error loading provinces:', error);
            setErrorState(provinceSelect, 'Failed to load provinces: ' + error.message);
        }
    });

    // Province change handler
    provinceSelect.addEventListener('change', async function() {
        resetDependentFields('city');

        if (!this.value) {
            return;
        }

        setLoadingState(citySelect);
        try {
            const cities = await fetchJsonData("{% static 'philippine-addresses/city.json' %}");
            const selectedProvinceCode = this.value;
            console.log('Selected province code:', selectedProvinceCode);
            const filteredCities = cities.filter(city =>
                city.province_code === selectedProvinceCode
            );
            console.log('Filtered cities:', filteredCities);
            if (filteredCities.length > 0) {
                updateSelect(citySelect, filteredCities.map(city => ({
                    code: city.city_code,
                    name: city.city_name
                })), 'Select City/Municipality...');
            } else {
                setErrorState(citySelect, 'No cities found');
            }
        } catch (error) {
            setErrorState(citySelect, 'Failed to load cities');
            console.error('Error:', error);
        }
    });

    // City change handler
    citySelect.addEventListener('change', async function() {
        resetDependentFields('barangay');

        if (!this.value) {
            return;
        }

        setLoadingState(barangaySelect);
        try {
            const barangays = await fetchJsonData("{% static 'philippine-addresses/barangay.json' %}");
            const filteredBarangays = barangays.filter(barangay =>
                barangay.city_code === this.value
            );
            if (filteredBarangays.length > 0) {
                updateSelect(barangaySelect, filteredBarangays.map(barangay => ({
                    code: barangay.brgy_code,
                    name: barangay.brgy_name
                })), 'Select Barangay...');
            } else {
                setErrorState(barangaySelect, 'No barangays found');
            }
        } catch (error) {
            setErrorState(barangaySelect, 'Failed to load barangays');
        }
    });

    // Age calculation from birthday
    const birthdayInput = document.getElementById('id_birthday');
    const ageInput = document.getElementById('calculated_age');
    function calculateAge(birthday) {
        if (!birthday) return '';
        const today = new Date();
        const birthDate = new Date(birthday);
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age >= 0 ? age : '';
    }
    if (birthdayInput) {
        birthdayInput.addEventListener('change', function() {
            ageInput.value = calculateAge(this.value);
        });
        // Set initial value if editing
        ageInput.value = calculateAge(birthdayInput.value);
    }

    // Restrict contact number input to digits only and limit to 13 characters
    const contactNumberInput = document.getElementById('id_contact_number');
    if (contactNumberInput) {
        // Prevent non-digit key presses and limit length
        contactNumberInput.addEventListener('keydown', function(e) {
            // Allow control keys (backspace, delete, tab, escape, enter, arrows, etc.)
            const controlKeys = [8, 9, 13, 27, 37, 38, 39, 40, 46];
            if (controlKeys.includes(e.keyCode) || e.ctrlKey || e.metaKey) {
                return;
            }

            // Allow only digits 0-9
            if (e.keyCode < 48 || e.keyCode > 57) {
                e.preventDefault();
                return false;
            }

    // Prevent input if already 11 characters
    if (this.value.length >= 11) {
        e.preventDefault();
        return false;
    }
        });

        // Clean input in real-time and enforce length limit
        contactNumberInput.addEventListener('input', function(e) {
            // Remove any non-digit characters
            let cleanedValue = this.value.replace(/\D/g, '');
    // Limit to 11 characters
    if (cleanedValue.length > 11) {
        cleanedValue = cleanedValue.slice(0, 11);
    }
            this.value = cleanedValue;
        });

        // Handle paste events
        contactNumberInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
    const digitsOnly = pastedText.replace(/\D/g, '').slice(0, 11);
            this.value = digitsOnly;
        });

        // Also handle drop events (drag and drop)
        contactNumberInput.addEventListener('drop', function(e) {
            e.preventDefault();
            const droppedText = e.dataTransfer.getData('text');
    const digitsOnly = droppedText.replace(/\D/g, '').slice(0, 11);
            this.value = digitsOnly;
        });
    }

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        let errors = [];

        // Required fields except street_address
        const requiredFields = ['id_first_name', 'id_last_name', 'id_birthday', 'id_sex', 'id_marital_status', 'id_patient_type', 'id_patient_status', 'id_region', 'id_province', 'id_city', 'id_barangay', 'id_contact_number', 'id_email'];

        for (let id of requiredFields) {
            const field = document.getElementById(id);
            if (!field.value.trim()) {
                isValid = false;
                errors.push(`${field.previousElementSibling ? field.previousElementSibling.textContent.trim() : id.replace('id_', '').replace('_', ' ')} is required.`);
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }

        // Conditional id_number
        const patientType = document.getElementById('id_patient_type').value;
        if (patientType === 'SENIOR' || patientType === 'PWD') {
            const idNumber = document.getElementById('id_id_number');
            if (!idNumber.value.trim()) {
                isValid = false;
                errors.push('ID Number is required for Senior Citizen/PWD.');
                idNumber.classList.add('is-invalid');
            } else {
                idNumber.classList.remove('is-invalid');
            }
        }

        // Contact number validation
        const contactNumber = document.getElementById('id_contact_number');
        if (contactNumber.value && !/^\d{11}$/.test(contactNumber.value)) {
            isValid = false;
            errors.push('Contact number must be exactly 11 digits.');
            contactNumber.classList.add('is-invalid');
        }

        // Email validation
        const email = document.getElementById('id_email');
        if (email.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
            isValid = false;
            errors.push('Please enter a valid email address.');
            email.classList.add('is-invalid');
        }

        if (!isValid) {
            e.preventDefault();
            alert(errors.join('\n'));
        }
    });
});
</script>
{% endblock %} 