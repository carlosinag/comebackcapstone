{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Ultrasound Clinic{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    {% if user.is_authenticated %}
    <meta name="user-id" content="{{ user.id }}">
    {% endif %}
    <style>
        /* ========== SKELETON LOADING STYLES ========== */
        #skeleton-loader {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 100vh;
            background: #ecf0f1;
            z-index: 100;
            display: flex;
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.3s ease-out, left 0.3s ease;
            padding: 30px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #skeleton-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #skeleton-loader.removed {
            display: none;
        }

        /* Prevent skeleton from rendering under sidebar */
        #content {
            position: relative;
            overflow-x: hidden;
        }

        /* Mobile: Full width (sidebar is hidden) */
        @media (max-width: 768px) {
            #skeleton-loader {
                left: 0;
                width: 100%;
            }
        }

        #skeleton-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #skeleton-loader.removed {
            display: none;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, #e0e0e0 0px, #f0f0f0 40px, #e0e0e0 80px);
            background-size: 800px 100%;
            animation: skeleton-shimmer 1.8s infinite linear;
            border-radius: 4px;
        }

        .skeleton-pulse {
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Content area positioning for skeleton */
        #content {
            position: relative; /* Important for absolute positioning of skeleton */
        }

        /* Skeleton Content Layouts */
        .skeleton-title {
            width: 35%;
            height: 36px;
            margin-bottom: 12px;
        }

        .skeleton-subtitle {
            width: 50%;
            height: 20px;
            margin-bottom: 30px;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 10px;
        }

        .skeleton-text.short { width: 40%; }
        .skeleton-text.medium { width: 60%; }
        .skeleton-text.long { width: 85%; }

        .skeleton-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .skeleton-card {
            height: 140px;
            border-radius: 8px;
        }

        .skeleton-table {
            width: 100%;
            border-radius: 8px;
        }

        .skeleton-table-header {
            height: 50px;
            margin-bottom: 2px;
        }

        .skeleton-table-row {
            height: 60px;
            margin-bottom: 2px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #skeleton-loader {
                padding: 15px;
            }
            .skeleton-title { width: 60%; }
            .skeleton-cards-grid { grid-template-columns: 1fr; }
        }

        /* Page content visibility control */
        #content.skeleton-loading > *:not(#skeleton-loader) {
            opacity: 0;
        }

        #content.skeleton-loaded > *:not(#skeleton-loader) {
            opacity: 1;
            transition: opacity 0.3s ease-in;
        }

        /* Input Capitalization */
        input[type="text"]:not([class*="search"]):not([class*="username"]):not([class*="email"]):not([class*="password"]),
        textarea:not([class*="no-caps"]) {
            text-transform: capitalize;
        }
        
        /* Exclude email addresses from capitalization */
        input[type="email"],
        input[name*="email"],
        input[id*="email"] {
            text-transform: none !important;
        }
        
        :root {
            --sidebar-width: 250px;
        }
        
        .wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        #sidebar {
            width: var(--sidebar-width);
            background: #2c3e50;
            color: white;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        #sidebar .sidebar-header {
            padding: 15px;
            background: #2c3e50;
        }
        
        #sidebar ul.components {
            flex-grow: 1;
        }
        
        #sidebar ul li a {
            padding: 15px 20px;
            display: block;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            margin-bottom: 2px;
        }
        
        #sidebar ul li a:hover {
            background: #34495e;
        }
        
        #sidebar ul li a.active {
            background: #3498db;
        }
        
        #sidebar ul li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        #content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 20px;
            min-height: 100vh;
            transition: all 0.3s;
        }
        
        @media (max-width: 768px) {
            #sidebar {
                margin-left: calc(-1 * var(--sidebar-width));
            }
            #sidebar.active {
                margin-left: 0;
            }
            #content {
                margin-left: 0;
                width: 100%;
            }
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
        }
        
        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
            }
        }

        /* Profile Dropdown Styling */
        .sidebar-profile {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 15px !important;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: 10px !important;
        }

        .sidebar-profile:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .sidebar-profile:focus {
            outline: none;
            background: rgba(52, 152, 219, 0.15);
        }

        .sidebar-profile .avatar {
            flex-shrink: 0;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .sidebar-profile:hover .avatar {
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
            transform: scale(1.05);
        }

        .sidebar-profile span {
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .sidebar-profile i {
            transition: transform 0.3s ease;
            margin-left: 12px;
            flex-shrink: 0;
        }

        .sidebar-profile[aria-expanded="true"] i {
            transform: rotate(180deg);
        }

        .profile-dropdown {
            min-width: 200px !important;
            border-radius: 12px !important;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25) !important;
            border: 1px solid rgba(52, 152, 219, 0.2) !important;
            background: white !important;
            padding: 10px 0 !important;
            animation: dropdownSlideIn 0.3s ease !important;
            transform-origin: top left;
            position: fixed !important;
        }

        .profile-dropdown::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 75%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid white;
            filter: drop-shadow(-2px 0 2px rgba(0, 0, 0, 0.1));
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-dropdown.hide {
            animation: dropdownSlideOut 0.3s ease !important;
        }

        @keyframes dropdownSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .profile-dropdown .dropdown-item {
            padding: 12px 16px !important;
            color: #2c3e50 !important;
            font-weight: 500;
            transition: all 0.2s ease !important;
            border-left: 3px solid transparent;
        }

        .profile-dropdown .dropdown-item:hover {
            background: #ecf0f1 !important;
            border-left-color: #3498db;
            padding-left: 18px !important;
        }

        .profile-dropdown .dropdown-item i {
            margin-right: 10px;
            width: 16px;
            text-align: center;
        }

        .profile-dropdown .dropdown-item.text-danger {
            color: #e74c3c !important;
        }

        .profile-dropdown .dropdown-item.text-danger:hover {
            background: #fadbd8 !important;
            border-left-color: #e74c3c;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="skeleton-active">
<!-- ========== SKELETON LOADER ========== -->
{% block skeleton %}
{% if not disable_skeleton %}
<div id="skeleton-loader">
    {% block skeleton_content %}
    <!-- Default Skeleton Layout - Header, Search Bar, and Banners -->
    <div style="max-width: 100%; overflow: hidden;">
        <!-- Page Header -->
        <div class="skeleton skeleton-title" style="width: 180px; height: 32px; margin-bottom: 25px;"></div>

        <!-- Search Section -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);">
            <!-- "Search Patients" label -->
            <div class="skeleton" style="width: 130px; height: 20px; margin-bottom: 15px;"></div>
            
            <!-- Search bar with button -->
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="skeleton" style="flex: 1; height: 42px; border-radius: 4px;"></div>
                <div class="skeleton" style="width: 90px; height: 42px; border-radius: 4px;"></div>
            </div>
        </div>

        <!-- Quick Action Cards Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <!-- Card 1: New Patient -->
            <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); display: flex; align-items: center; gap: 20px;">
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 120px; height: 22px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 150px; height: 16px;"></div>
                </div>
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;"></div>
            </div>

            <!-- Card 2: Patient List -->
            <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); display: flex; align-items: center; gap: 20px;">
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 100px; height: 22px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 170px; height: 16px;"></div>
                </div>
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;"></div>
            </div>

            <!-- Card 3: Billing -->
            <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); display: flex; align-items: center; gap: 20px;">
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 80px; height: 22px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 160px; height: 16px;"></div>
                </div>
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;"></div>
            </div>

            <!-- Card 4: Appointments -->
            <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); display: flex; align-items: center; gap: 20px;">
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 140px; height: 22px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 180px; height: 16px;"></div>
                </div>
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;"></div>
            </div>
        </div>
    </div>
    {% endblock %}
</div>
{% endif %}
{% endblock %}

    <!-- ========== WRAPPER ========== -->
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0">
                    <img src="{% static 'logo.png' %}" alt="Clinic Logo" style="height:2em; width:auto; margin:0 6px 0 0; vertical-align:middle;">
                </h5>            
            </div>

            <ul class="list-unstyled components flex-grow-1">
                <!-- ADMIN SIDEBAR -->
                {% if user.is_superuser %}
                    <li>
                        <a href="{% url 'admin_dashboard' %}" class="{% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'admin_analytics' %}" class="{% if request.resolver_match.url_name == 'admin_analytics' %}active{% endif %}">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'admin_patient_list' %}" class="{% if request.resolver_match.url_name == 'admin_patient_list' %}active{% endif %}">
                            <i class="fas fa-users"></i> Patients
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'admin-archived-patient-list' %}" class="{% if request.resolver_match.url_name == 'admin-archived-patient-list' %}active{% endif %}">
                            <i class="fas fa-archive"></i> Archived Patients
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'admin_examinations' %}" class="{% if request.resolver_match.url_name == 'admin_examinations' %}active{% endif %}">
                            <i class="fas fa-notes-medical"></i> Examinations
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'admin_billing_report' %}" class="{% if request.resolver_match.url_name == 'admin_billing_report' %}active{% endif %}">
                            <i class="fas fa-file-invoice-dollar"></i> Billing Report
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'admin_prices' %}" class="{% if request.resolver_match.url_name == 'admin_prices' %}active{% endif %}">
                            <i class="fas fa-tags"></i> Prices
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'admin_users' %}" class="{% if request.resolver_match.url_name == 'admin_users' %}active{% endif %}">
                            <i class="fas fa-users-cog"></i> Users
                        </a>
                    </li>
                    <!-- <li>
                        <a href="{% url 'home-dashboard' %}">
                            <i class="fas fa-arrow-left"></i> Back to Site
                        </a>
                    </li> -->
                <!-- STAFF SIDEBAR -->
                {% else %}
                    <li>
                        <a href="{% url 'home-dashboard' %}" class="{% if request.resolver_match.url_name == 'home-dashboard' %}active{% endif %}">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'patient-list' %}" class="{% if request.resolver_match.url_name == 'patient-list' and not request.GET.view %}active{% endif %}">
                            <i class="fas fa-users"></i> Patient List
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'patient-list' %}?view=annotation" class="{% if request.resolver_match.url_name == 'patient-list' and request.GET.view == 'annotation' %}active{% endif %}">
                            <i class="fas fa-draw-polygon"></i> Image Annotation
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'billing:bill_list' %}" class="{% if 'billing' in request.path %}active{% endif %}">
                            <i class="fas fa-file-invoice-dollar"></i> Billing
                        </a>
                    </li>
                    <li class="mt-auto">
                        <a href="{% url 'admin_login' %}" class="{% if request.resolver_match.url_name == 'admin_login' %}active{% endif %}">
                            <i class="fas fa-user-shield"></i> Admin Panel
                        </a>
                    </li>
                {% endif %}
            </ul>

            <!-- Profile Dropdown -->
            {% if user.is_authenticated and user.is_staff or user.is_superuser %}
            <div class="sidebar-profile d-flex align-items-center mb-3 px-3 w-100" id="sidebarProfile" tabindex="0" aria-expanded="false">
                <div class="avatar rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                     style="width:2rem;height:2rem;font-size:1rem;">
                    {{ user.first_name|slice:':1' }}{{ user.last_name|slice:':1' }}
                </div>
                <span class="fw-semibold">{{ user.first_name }} {{ user.last_name }}</span>
                <i class="fas fa-caret-down"></i>

                <div class="profile-dropdown dropdown-menu shadow" id="profileDropdown"
                     style="display:none;">
                    <!-- Admin Logout -->
                    {% if user.is_superuser %}
                        <form id="logoutForm" method="post" action="{% url 'admin_logout' %}" style="display:none;">
                            {% csrf_token %}
                        </form>
                        <button class="dropdown-item text-danger" id="profileLogoutBtn" type="button">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    <!-- Staff Logout -->
                    {% else %}
                        <button class="dropdown-item" id="profileSettingsBtn" type="button">
                            <i class="fas fa-sliders-h"></i> Settings
                        </button>
                        <button class="dropdown-item text-danger" id="profileLogoutBtn" type="button">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </nav>

        <!-- Mobile Toggle Button -->
        <button class="btn btn-primary sidebar-toggle" type="button">
            <i class="fas fa-bars"></i>
        </button>

        {% if user.is_superuser %}
        <!-- Floating back button for admins when no sidebar item is active -->
        <button id="adminBackBtn" class="btn btn-secondary shadow d-flex align-items-center" style="display:none !important; position:fixed; bottom:20px; right:20px; z-index:1100; border-radius:999px; padding:8px 12px; gap:8px; min-height:44px;" aria-label="Back to admin dashboard" title="Back to Admin Dashboard" role="button">
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
            <span style="font-weight:600; font-size:0.95rem; color:inherit;">Back to Dashboard</span>
        </button>
        {% endif %}

        <!-- Page Content -->
        <div id="content">
            {% block content %}{% endblock %}
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="{% static 'js/notifications.js' %}"></script>
    {% if not user.is_superuser %}
    <script src="{% static 'js/dashboard.js' %}"></script>
    {% endif %}
    <script>
        $(document).ready(function() {
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            const sidebar = document.querySelector('#sidebar');
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });

            // Wait a bit for the notification system to initialize
            setTimeout(function() {
                // Handle Django messages with Toastr
                {% if messages %}
                    {% for message in messages %}
                        {% if message.tags == 'success' %}
                            if (typeof toastr !== 'undefined') {
                                toastr.success('{{ message|escapejs }}');
                            }
                        {% elif message.tags == 'error' %}
                            if (typeof toastr !== 'undefined') {
                                toastr.error('{{ message|escapejs }}');
                            }
                        {% elif message.tags == 'warning' %}
                            if (typeof toastr !== 'undefined') {
                                toastr.warning('{{ message|escapejs }}');
                            }
                        {% elif message.tags == 'info' %}
                            if (typeof toastr !== 'undefined') {
                                toastr.info('{{ message|escapejs }}');
                            }
                        {% else %}
                            if (typeof toastr !== 'undefined') {
                                toastr.info('{{ message|escapejs }}');
                            }
                        {% endif %}
                    {% endfor %}
                {% endif %}
            }, 100);

            // Floating admin back button: show only for admins and only when no sidebar item is active
            (function() {
                var $adminBack = $('#adminBackBtn');
                if (!$adminBack.length) return; // not an admin or button not rendered

                function updateBackButtonVisibility() {
                    // consider any active link/list-item or aria-current in the sidebar as "page selected"
                    var hasActive = $('#sidebar ul.components a.active, #sidebar ul.components li.active, #sidebar ul.components a[aria-current="page"], #sidebar ul.components .active').length > 0;
                    if (!hasActive) {
                        // show with fade only when appropriate
                        $adminBack.stop(true, true).fadeIn(200);
                    } else {
                        $adminBack.stop(true, true).fadeOut(150);
                    }
                }

                // initial check with slight delay to ensure active classes are rendered by server
                setTimeout(updateBackButtonVisibility, 50);

                // hide immediately on early navigation events (prevents brief fade during page unload)
                $('#sidebar ul.components a').on('mousedown touchstart', function() {
                    $adminBack.stop(true, true).hide();
                });

                // also hide on beforeunload to prevent flash while the browser navigates
                window.addEventListener('beforeunload', function() {
                    $adminBack.style.display = 'none';
                });

                // if navigation does not unload page, update visibility after click
                $('#sidebar ul.components a').on('click', function() {
                    setTimeout(updateBackButtonVisibility, 80);
                });

                // click / keyboard activation: go back to admin dashboard
                $adminBack.on('click keydown', function(e) {
                    if (e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
                        window.location.href = "{% url 'admin_dashboard' %}";
                    }
                });

                // hide on Esc
                $(document).on('keydown', function(e) {
                    if (e.key === 'Escape' && $adminBack.is(':visible')) {
                        $adminBack.stop(true, true).fadeOut(150);
                    }
                });
            })();
        });

        // Test function for notifications (remove after testing)
        window.testNotification = function(type) {
            if (typeof toastr !== 'undefined') {
                switch(type) {
                    case 'success':
                        toastr.success('This is a test success notification!', 'Success');
                        break;
                    case 'error':
                        toastr.error('This is a test error notification!', 'Error');
                        break;
                    case 'warning':
                        toastr.warning('This is a test warning notification!', 'Warning');
                        break;
                    case 'info':
                        toastr.info('This is a test info notification!', 'Info');
                        break;
                }
            } else {
                alert('Toastr is not loaded!');
            }
        };
    </script>
    
    <!-- Real-time Notifications for Staff -->
    {% if user.is_authenticated and not user.is_superuser %}
    <script src="{% static 'js/realtime_notifications.js' %}"></script>
    {% endif %}
    
    <!-- Profile Dropdown Script -->
    {% if user.is_authenticated and user.is_staff or user.is_superuser %}
    <script>
    $(document).ready(function() {
        var $profile = $('#sidebarProfile');
        var $dropdown = $('#profileDropdown');
        
        function positionDropdown() {
            var profileRect = $profile[0].getBoundingClientRect();
            var sidebarWidth = 250; // var(--sidebar-width)
            $dropdown.css({
                'top': (profileRect.top + profileRect.height - 110) + 'px',
                'left': (sidebarWidth + 15) + 'px'
            });
        }
        
        $profile.on('click keydown', function(e) {
            if(e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const isVisible = $dropdown.is(':visible');
                
                if(isVisible) {
                    $dropdown.addClass('hide');
                    setTimeout(() => {
                        $dropdown.hide().removeClass('hide');
                        $profile.attr('aria-expanded', 'false');
                    }, 300);
                } else {
                    positionDropdown();
                    $dropdown.show();
                    $profile.attr('aria-expanded', 'true');
                }
            }
        });
        
        // Hide dropdown on click outside
        $(document).on('mousedown', function(e) {
            if (!$profile.is(e.target) && $profile.has(e.target).length === 0 && 
                !$dropdown.is(e.target) && $dropdown.has(e.target).length === 0) {
                if($dropdown.is(':visible')) {
                    $dropdown.addClass('hide');
                    setTimeout(() => {
                        $dropdown.hide().removeClass('hide');
                        $profile.attr('aria-expanded', 'false');
                    }, 300);
                }
            }
        });

        // Logout button click
        $('#profileLogoutBtn').on('click', function() {
            {% if user.is_superuser %}
                document.getElementById('logoutForm').submit();
            {% else %}
                window.location.href = "{% url 'staff_logout' %}";
            {% endif %}
        });
        
        // Hide dropdown on Esc
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape' && $dropdown.is(':visible')) {
                $dropdown.addClass('hide');
                setTimeout(() => {
                    $dropdown.hide().removeClass('hide');
                    $profile.attr('aria-expanded', 'false');
                }, 300);
            }
        });
    });
    </script>
    {% endif %}
    
    <script>
        function showSkeleton() {
            const el = document.getElementById('skeleton-loader');
            if (el) el.classList.remove('hidden');
        }

        function hideSkeleton() {
            const el = document.getElementById('skeleton-loader');
            if (el) el.classList.add('hidden');
        }

        window.addEventListener("beforeunload", () => {
            // only show if skeleton exists inside page
            const el = document.getElementById("skeleton-loader");
            if (el) showSkeleton();
        });
    </script>

    {% block extra_js %}{% endblock %}
    <!-- ========== SKELETON LOADING SCRIPT ========== -->
    <script>
        {% if not disable_skeleton %}
        (function() {
            const skeletonLoader = document.getElementById('skeleton-loader');
            const contentDiv = document.getElementById('content');
            
            // ⏱️ DELAY CONFIGURATION (in milliseconds)
            const SKELETON_MIN_DISPLAY = 100;  // Minimum time to show skeleton (prevents flash)
            const SKELETON_TEST_DELAY = 0;  // Extra delay for testing (SET TO 0 for production)
            
            const startTime = performance.now();
            
            function hideSkeletonLoader() {
                const elapsed = performance.now() - startTime;
                const totalDelay = SKELETON_MIN_DISPLAY + SKELETON_TEST_DELAY;
                const remainingDelay = Math.max(0, totalDelay - elapsed);
                
                setTimeout(() => {
                    if (skeletonLoader) {
                        skeletonLoader.classList.add('hidden');
                    }
                    if (contentDiv) {
                        contentDiv.classList.remove('skeleton-loading');
                        contentDiv.classList.add('skeleton-loaded');
                    }
                    
                    // Remove from DOM after fade transition
                    setTimeout(() => {
                        if (skeletonLoader) {
                            skeletonLoader.classList.add('removed');
                        }
                    }, 300);
                }, remainingDelay);
            }
            
            // Hide skeleton when page fully loaded
            if (document.readyState === 'complete') {
                hideSkeletonLoader();
            } else {
                window.addEventListener('load', hideSkeletonLoader);
            }
            
            // Fallback: force hide after max time
            const maxTimeout = SKELETON_MIN_DISPLAY + SKELETON_TEST_DELAY + 3000;
            setTimeout(() => {
                if (skeletonLoader && !skeletonLoader.classList.contains('hidden')) {
                    hideSkeletonLoader();
                }
            }, maxTimeout);
        })();
        {% endif %}
    </script>
</body>
</html>