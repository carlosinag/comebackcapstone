{% extends 'base.html' %}

{% block skeleton %}
{% endblock %}

{% block title %}Admin Analytics{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    <h1 class="h3 mb-4">Admin Analytics</h1>

    <!-- Analytics Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Weekly Revenue</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">₱{{ weekly_revenue }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-peso-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Active Patients (90d)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ active_patients_90d }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">New Patients (Month)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ new_patients_month }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-plus fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-dark shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">Avg Procedures / Patient</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ avg_procedures_per_patient }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insight Banners -->
    <div class="row mb-4">
        <div class="col-lg-4 mb-3">
            <div class="card border-left-primary shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Revenue in period
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                        ₱{{ filtered_revenue_total|default:'0.00' }}
                    </div>
                    {% if filtered_revenue_change_percent %}
                        <div class="mt-2 small text-muted">
                            vs previous period: {{ filtered_revenue_change_percent }}%
                        </div>
                    {% else %}
                        <div class="mt-2 small text-muted">
                            Change vs previous period: N/A
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-3">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                        Top procedure in period
                    </div>
                    {% if filtered_top_procedure_name %}
                        <div class="h6 mb-0 font-weight-bold text-gray-800">
                            {{ filtered_top_procedure_name }}
                        </div>
                        <div class="mt-1 small text-muted">
                            {{ filtered_top_procedure_count }} procedures
                        </div>
                    {% else %}
                        <div class="small text-muted">
                            No procedure data in this date range.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-3">
            <div class="card border-left-warning shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                        Top region by revenue
                    </div>
                    {% if filtered_top_region_label %}
                        <div class="h6 mb-0 font-weight-bold text-gray-800">
                            {{ filtered_top_region_label }}
                        </div>
                        <div class="mt-1 small text-muted">
                            ₱{{ filtered_top_region_revenue }}
                        </div>
                    {% else %}
                        <div class="small text-muted">
                            No regional revenue data in this date range.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if filters_applied and not has_filtered_data %}
        <div class="alert alert-light border-left-warning mb-4">
            No data found for the selected date range. Charts below may appear empty.
        </div>
    {% endif %}

    <!-- Charts Row 1 -->
    <div class="row">
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Procedure Type Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="procedureDistributionChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Findings Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="findingsDistributionChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row">
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Daily Revenue (Current Month)</h6>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 400px;">
                        <canvas id="monthlyRevenueChart"></canvas>
                    </div>
                    <!-- Month Navigation -->
                    <div class="d-flex justify-content-center align-items-center mt-3 gap-3">
                        <button id="prevMonthBtn" class="btn btn-sm btn-outline-primary" style="width: 40px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="currentMonth" class="font-weight-bold mx-3" style="min-width: 120px; text-align: center;">December 2025</span>
                        <button id="nextMonthBtn" class="btn btn-sm btn-outline-primary" style="width: 40px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Daily Procedures (Current Week)</h6>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 400px;">
                    <canvas id="weekProceduresChart"></canvas>
                </div>
                <!-- Week Navigation -->
                <div class="d-flex justify-content-center align-items-center mt-3 gap-3">
                    <button id="prevWeekBtn" class="btn btn-sm btn-outline-primary" style="width: 40px;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="currentWeek" class="font-weight-bold mx-3" style="min-width: 200px; text-align: center;">Week of Dec 8, 2025</span>
                    <button id="nextWeekBtn" class="btn btn-sm btn-outline-primary" style="width: 40px;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Charts Row 3: Demographics -->
    <div class="row">
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Gender Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="genderDistributionChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Patient Type Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="patientTypeChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 4: Age and Top Patients -->
    <div class="row">
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Age Bins</h6>
                </div>
                <div class="card-body">
                    <canvas id="ageBucketChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top Patients by Revenue</h6>
                </div>
                <div class="card-body">
                    <canvas id="topPatientsRevenueChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 5: Revenue by Procedure Type -->
    <div class="row">
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Revenue by Procedure Type</h6>
                </div>
                <div class="card-body">
                    <canvas id="procedureRevenueChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Procedure Count and Revenue (Top 10)</h6>
                </div>
                <div class="card-body">
                    <canvas id="procedureCountRevenueChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 6: Revenue by Location -->
    <div class="row">
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Revenue by Region</h6>
                </div>
                <div class="card-body">
                    <canvas id="locationRevenueChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Revenue by City (Top 10)</h6>
                </div>
                <div class="card-body">
                    <canvas id="cityRevenueChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 7: Payment Method and Patient Type Revenue -->
    <div class="row">
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Revenue by Payment Method</h6>
                </div>
                <div class="card-body">
                    <canvas id="paymentMethodChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Revenue by Patient Type</h6>
                </div>
                <div class="card-body">
                    <canvas id="patientTypeRevenueChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 8: Monthly Revenue Trends -->
    <div class="row">
        <div class="col-xl-12 col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Monthly Revenue Trends</h6>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 400px;">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                    <!-- Year Navigation -->
                    <div class="d-flex justify-content-center align-items-center mt-3 gap-3">
                        <button id="prevYearBtn" class="btn btn-sm btn-outline-primary" style="width: 40px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="currentYear" class="font-weight-bold mx-3" style="min-width: 60px; text-align: center;">2025</span>
                        <button id="nextYearBtn" class="btn btn-sm btn-outline-primary" style="width: 40px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Global Filters Button -->
    <button type="button"
            class="btn btn-primary shadow filter-fab"
            data-bs-toggle="modal"
            data-bs-target="#globalFilterModal"
            aria-label="Open filters">
        <i class="fas fa-filter"></i>
    </button>

    <!-- Global Filters Modal -->
    <div class="modal fade" id="globalFilterModal" tabindex="-1" role="dialog" aria-labelledby="globalFilterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <form method="get">
                    <div class="modal-header">
                        <h5 class="modal-title" id="globalFilterModalLabel">Analytics Filters</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="modal_start_date" class="small mb-1">Start date</label>
                                <input type="date"
                                       id="modal_start_date"
                                       name="start_date"
                                       class="form-control"
                                       value="{% if filter_start_date %}{{ filter_start_date|date:'Y-m-d' }}{% endif %}">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="modal_end_date" class="small mb-1">End date</label>
                                <input type="date"
                                       id="modal_end_date"
                                       name="end_date"
                                       class="form-control"
                                       value="{% if filter_end_date %}{{ filter_end_date|date:'Y-m-d' }}{% endif %}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modal_preset" class="small mb-1">Quick range</label>
                            <select id="modal_preset" name="preset" class="form-control">
                                <option value="all" {% if filter_preset == 'all' or not filter_preset %}selected{% endif %}>All time</option>
                                <option value="last_7" {% if filter_preset == 'last_7' %}selected{% endif %}>Last 7 days</option>
                                <option value="last_30" {% if filter_preset == 'last_30' %}selected{% endif %}>Last 30 days</option>
                                <option value="this_month" {% if filter_preset == 'this_month' %}selected{% endif %}>This month</option>
                                <option value="this_year" {% if filter_preset == 'this_year' %}selected{% endif %}>This year</option>
                            </select>
                        </div>
                        <small class="text-muted d-block">
                            {% if filter_preset == 'all' and not filter_start_date %}
                                Currently showing all available data.
                            {% elif filter_start_date and filter_end_date %}
                                Currently showing data from {{ filter_start_date }} to {{ filter_end_date }}.
                            {% else %}
                                Currently showing default period.
                            {% endif %}
                        </small>
                    </div>
                    <div class="modal-footer">
                        <a href="{% url 'admin_analytics' %}" class="btn btn-outline-secondary">Reset</a>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% block extra_js %}
<style>
    .filter-fab {
        position: fixed;
        bottom: 1.75rem;
        right: 1.75rem;
        z-index: 1030;
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    @media (max-width: 576px) {
        .filter-fab {
            bottom: 1.25rem;
            right: 1.25rem;
        }
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    /* eslint-disable */
    // Ensure Bootstrap 5 modal works even if data attributes fail
    document.addEventListener('DOMContentLoaded', function () {
        var filterBtn = document.querySelector('.filter-fab');
        var modalEl = document.getElementById('globalFilterModal');
        if (filterBtn && modalEl && window.bootstrap && bootstrap.Modal) {
            var modal = new bootstrap.Modal(modalEl);
            filterBtn.addEventListener('click', function (e) {
                e.preventDefault();
                modal.show();
            });
        }
    });

    const chartColors = {
        primary: '#4e73df',
        secondary: '#1cc88a',
        accent: '#36b9cc',
        warning: '#f6c23e',
        danger: '#e74a3b',
        gray: '#858796'
    };

    const categoricalColors = [
        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
        '#e74a3b', '#858796', '#5a5c69', '#2e59d9',
        '#17a673', '#2c9faf'
    ];

    const pesoFormatter = (value) => {
        if (value === null || value === undefined || isNaN(value)) return '₱0';
        return '₱' + Number(value).toLocaleString('en-PH');
    };

    function createChart(ctxId, config) {
        const canvas = document.getElementById(ctxId);
        if (!canvas) return null;
        return new Chart(canvas, config);
    }

    // Procedure Type Distribution (Doughnut)
    const procedureDistributionData = {{ procedure_distribution_data|default:'[]'|safe }};
    const procedureDistributionLabels = {{ procedure_distribution_labels|default:'[]'|safe }};
    createChart('procedureDistributionChart', {
        type: 'doughnut',
        data: {
            labels: procedureDistributionLabels,
            datasets: [{
                data: procedureDistributionData,
                backgroundColor: categoricalColors,
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 10
                }
            },
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    labels: {
                        boxWidth: 15,
                        boxHeight: 15,
                        padding: 10,
                        font: {
                            size: 11
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: ${value} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Findings Distribution (Doughnut)
    const findingsDistributionData = {{ findings_distribution_data|default:'[]'|safe }};
    const findingsDistributionLabels = {{ findings_distribution_labels|default:'[]'|safe }};
    createChart('findingsDistributionChart', {
        type: 'doughnut',
        data: {
            labels: findingsDistributionLabels,
            datasets: [{
                data: findingsDistributionData,
                backgroundColor: categoricalColors,
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 10
                }
            },
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    labels: {
                        boxWidth: 15,
                        boxHeight: 15,
                        padding: 10,
                        font: {
                            size: 11
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: ${value} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Daily Revenue (Current Month) - Line with Month Navigation
    const dailyRevenueLabels = {{ daily_revenue_dates|default:'[]'|safe }};
    const dailyRevenueValues = {{ daily_revenue_values|default:'[]'|safe }};

    // Parse the data to organize by month-year
    const allDailyData = {};
    dailyRevenueLabels.forEach((label, index) => {
        const date = new Date(label);
        const monthYear = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
        const day = date.getDate();
        
        if (!allDailyData[monthYear]) {
            allDailyData[monthYear] = {
                labels: [],
                revenue: [],
                dates: []
            };
        }
        allDailyData[monthYear].labels.push(day);
        allDailyData[monthYear].revenue.push(dailyRevenueValues[index]);
        allDailyData[monthYear].dates.push(date);
    });

    // Get available months and set current month
    const availableMonths = Object.keys(allDailyData).sort((a, b) => {
        return new Date(b) - new Date(a);
    });

    const currentDate = new Date();
    const currentMonthYear = currentDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    let currentDisplayMonth = availableMonths.includes(currentMonthYear) ? currentMonthYear : (availableMonths.length > 0 ? availableMonths[0] : currentMonthYear);

    // Create the chart
    let monthlyRevenueChart = null;

    function updateMonthlyRevenueChart(monthYear) {
        const canvas = document.getElementById('monthlyRevenueChart');
        if (!canvas) return;

        const monthData = allDailyData[monthYear];
        const hasData = monthData && monthData.labels.length > 0;

        // Destroy existing chart
        if (monthlyRevenueChart) {
            monthlyRevenueChart.destroy();
            monthlyRevenueChart = null;
        }

        if (!hasData) {
            // Show "No Data" message
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const containerHeight = container.clientHeight;
            const containerWidth = container.clientWidth;
            
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.font = '20px Arial';
            ctx.fillStyle = '#858796';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
            ctx.restore();
            return;
        }
        
        monthlyRevenueChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: monthData.labels,
                datasets: [{
                    label: 'Revenue',
                    data: monthData.revenue,
                    borderColor: chartColors.primary,
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: chartColors.primary,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                const date = monthData.dates[index];
                                return date.toLocaleDateString('en-US', { 
                                    month: 'long', 
                                    day: 'numeric', 
                                    year: 'numeric' 
                                });
                            },
                            label: function (context) {
                                return pesoFormatter(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Day of Month' },
                        ticks: { maxRotation: 0, autoSkip: true }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) { return pesoFormatter(value); }
                        }
                    }
                }
            }
        });
    }

    // Initialize chart with current month
    updateMonthlyRevenueChart(currentDisplayMonth);
    document.getElementById('currentMonth').textContent = currentDisplayMonth;

    // Month navigation button handlers
    document.getElementById('prevMonthBtn').addEventListener('click', function() {
        const currentIndex = availableMonths.indexOf(currentDisplayMonth);
        if (currentIndex !== -1 && currentIndex < availableMonths.length - 1) {
            currentDisplayMonth = availableMonths[currentIndex + 1];
        } else {
            // Go to previous month (might not have data)
            const [month, year] = currentDisplayMonth.split(' ');
            const date = new Date(`${month} 1, ${year}`);
            date.setMonth(date.getMonth() - 1);
            currentDisplayMonth = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
        }
        document.getElementById('currentMonth').textContent = currentDisplayMonth;
        updateMonthlyRevenueChart(currentDisplayMonth);
    });

    document.getElementById('nextMonthBtn').addEventListener('click', function() {
        const currentIndex = availableMonths.indexOf(currentDisplayMonth);
        if (currentIndex !== -1 && currentIndex > 0) {
            currentDisplayMonth = availableMonths[currentIndex - 1];
        } else {
            // Go to next month (might not have data)
            const [month, year] = currentDisplayMonth.split(' ');
            const date = new Date(`${month} 1, ${year}`);
            date.setMonth(date.getMonth() + 1);
            currentDisplayMonth = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
        }
        document.getElementById('currentMonth').textContent = currentDisplayMonth;
        updateMonthlyRevenueChart(currentDisplayMonth);
    });

    // Daily Procedures (Current Week) - Stacked Bar with Week Navigation
    const dailyProceduresData = {{ daily_procedures_data|default:'[]'|safe }};

    // Organize data by week
    const allWeeklyData = {};
    const procedureTypes = new Set();

    dailyProceduresData.forEach(day => {
        const date = new Date(day.date);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay()); // Sunday as start of week
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!allWeeklyData[weekKey]) {
            allWeeklyData[weekKey] = {};
        }
        
        const dayKey = day.date;
        allWeeklyData[weekKey][dayKey] = {};
        
        day.procedures.forEach(proc => {
            procedureTypes.add(proc.procedure_type__name);
            allWeeklyData[weekKey][dayKey][proc.procedure_type__name] = proc.count;
        });
    });

    // Get available weeks and set current week
    const availableWeeks = Object.keys(allWeeklyData).sort((a, b) => new Date(b) - new Date(a));
    const currentWeekStart = new Date(currentDate);
    currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());
    const currentWeekKey = currentWeekStart.toISOString().split('T')[0];
    let currentDisplayWeek = availableWeeks.includes(currentWeekKey) ? currentWeekKey : (availableWeeks.length > 0 ? availableWeeks[0] : currentWeekKey);

    // Create the chart
    let weekProceduresChart = null;
    const procedureTypesArray = Array.from(procedureTypes);

    function updateWeekProceduresChart(weekKey) {
        const canvas = document.getElementById('weekProceduresChart');
        if (!canvas) return;

        const weekData = allWeeklyData[weekKey] || {};
        const weekStart = new Date(weekKey);
        
        // Generate all 7 days of the week
        const daysOfWeek = [];
        const dayLabels = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(weekStart);
            day.setDate(weekStart.getDate() + i);
            daysOfWeek.push(day.toISOString().split('T')[0]);
            dayLabels.push(day.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
        }
        
        // Prepare datasets for each procedure type
        const datasets = procedureTypesArray.map((procType, index) => {
            return {
                label: procType,
                data: daysOfWeek.map(dayKey => {
                    return weekData[dayKey] && weekData[dayKey][procType] ? weekData[dayKey][procType] : 0;
                }),
                backgroundColor: categoricalColors[index % categoricalColors.length],
                borderColor: categoricalColors[index % categoricalColors.length],
                borderWidth: 1
            };
        });
        
        const hasData = datasets.some(ds => ds.data.some(v => v > 0));

        // Destroy existing chart
        if (weekProceduresChart) {
            weekProceduresChart.destroy();
            weekProceduresChart = null;
        }

        if (!hasData) {
            // Show "No Data" message
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const containerHeight = container.clientHeight;
            const containerWidth = container.clientWidth;
            
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.font = '20px Arial';
            ctx.fillStyle = '#858796';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
            ctx.restore();
            return;
        }
        
        weekProceduresChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: dayLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        align: 'center',
                        labels: {
                            boxWidth: 15,
                            boxHeight: 15,
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        filter: function(tooltipItem) { 
                            return tooltipItem.parsed.y !== 0;
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: { maxRotation: 45, minRotation: 0 }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
        
        // Update week display
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        document.getElementById('currentWeek').textContent = `Week of ${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
    }

    // Initialize chart with current week
    updateWeekProceduresChart(currentDisplayWeek);

    // Week navigation button handlers
    document.getElementById('prevWeekBtn').addEventListener('click', function() {
        const currentIndex = availableWeeks.indexOf(currentDisplayWeek);
        if (currentIndex !== -1 && currentIndex < availableWeeks.length - 1) {
            currentDisplayWeek = availableWeeks[currentIndex + 1];
        } else {
            // Go to previous week
            const date = new Date(currentDisplayWeek);
            date.setDate(date.getDate() - 7);
            currentDisplayWeek = date.toISOString().split('T')[0];
        }
        updateWeekProceduresChart(currentDisplayWeek);
    });

    document.getElementById('nextWeekBtn').addEventListener('click', function() {
        const currentIndex = availableWeeks.indexOf(currentDisplayWeek);
        if (currentIndex !== -1 && currentIndex > 0) {
            currentDisplayWeek = availableWeeks[currentIndex - 1];
        } else {
            // Go to next week
            const date = new Date(currentDisplayWeek);
            date.setDate(date.getDate() + 7);
            currentDisplayWeek = date.toISOString().split('T')[0];
        }
        updateWeekProceduresChart(currentDisplayWeek);
    });

    // Gender Distribution (Doughnut)
    const genderDistributionValues = {{ gender_distribution_values|default:'[]'|safe }};
    const genderDistributionLabels = {{ gender_distribution_labels|default:'[]'|safe }};
    createChart('genderDistributionChart', {
        type: 'doughnut',
        data: {
            labels: genderDistributionLabels,
            datasets: [{
                data: genderDistributionValues,
                backgroundColor: categoricalColors,
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    labels: {
                        boxWidth: 15,
                        boxHeight: 15,
                        padding: 10,
                    }
                }
            }
        }
    });

    // Patient Type Distribution (Doughnut)
    const patientTypeValues = {{ patient_type_values|default:'[]'|safe }};
    const patientTypeLabels = {{ patient_type_labels|default:'[]'|safe }};
    createChart('patientTypeChart', {
        type: 'doughnut',
        data: {
            labels: patientTypeLabels,
            datasets: [{
                data: patientTypeValues,
                backgroundColor: categoricalColors,
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    labels: {
                        boxWidth: 15,
                        boxHeight: 15,
                        padding: 10,
                    }
                }
            }
        }
    });

    // Age Bins - Bar
    const ageBucketLabels = {{ age_bucket_labels|default:'[]'|safe }};
    const ageBucketValues = {{ age_bucket_values|default:'[]'|safe }};
    createChart('ageBucketChart', {
        type: 'bar',
        data: {
            labels: ageBucketLabels,
            datasets: [{
                label: 'Patients',
                data: ageBucketValues,
                backgroundColor: chartColors.accent,
                borderColor: chartColors.accent,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { ticks: { maxRotation: 0 } },
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });

    // Top Patients by Revenue - Bar
    const topPatientsLabels = {{ top_patients_labels|default:'[]'|safe }};
    const topPatientsRevenue = {{ top_patients_revenue|default:'[]'|safe }};
    createChart('topPatientsRevenueChart', {
        type: 'bar',
        data: {
            labels: topPatientsLabels,
            datasets: [{
                label: 'Revenue',
                data: topPatientsRevenue,
                backgroundColor: chartColors.primary,
                borderColor: chartColors.primary,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return pesoFormatter(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) { return pesoFormatter(value); }
                    }
                }
            }
        }
    });

    // Revenue by Procedure Type - Doughnut
    const procedureRevenueValues = {{ procedure_revenue_values|default:'[]'|safe }};
    const procedureRevenueLabels = {{ procedure_revenue_labels|default:'[]'|safe }};
    createChart('procedureRevenueChart', {
        type: 'doughnut',
        data: {
            labels: procedureRevenueLabels,
            datasets: [{
                data: procedureRevenueValues,
                backgroundColor: categoricalColors,
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    labels: {
                        boxWidth: 15,
                        boxHeight: 15,
                        padding: 10,
                        font: {
                            size: 11
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    return {
                                        text: `${label}: ${pesoFormatter(value)}`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }   
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.label || '';
                            return label + ': ' + pesoFormatter(context.parsed);
                        }
                    }
                }
            }
        }
    });

    // Procedure Count and Revenue (Top 10) - Mixed Bar + Line with Dual Axis
    const procedureCountLabels = {{ procedure_revenue_labels|default:'[]'|safe }};
    const procedureCounts = {{ procedure_revenue_counts|default:'[]'|safe }};
    const procedureRevenues = {{ procedure_revenue_values|default:'[]'|safe }};
    createChart('procedureCountRevenueChart', {
        data: {
            labels: procedureCountLabels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Procedure Count',
                    data: procedureCounts,
                    backgroundColor: chartColors.secondary,
                    borderColor: chartColors.secondary,
                    borderWidth: 1,
                    yAxisID: 'y',
                    order: 2
                },
                {
                    type: 'line',
                    label: 'Revenue',
                    data: procedureRevenues,
                    borderColor: chartColors.primary,
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3,
                    pointBackgroundColor: chartColors.primary,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1',
                    borderDash: [],
                    fill: false,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                filler: {
                    propagate: true
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            if (context.dataset.label === 'Revenue') {
                                return context.dataset.label + ': ' + pesoFormatter(context.parsed.y);
                            }
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { autoSkip: true, maxRotation: 45 }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Procedure Count'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                    title: {
                        display: true,
                        text: 'Revenue (₱)'
                    },
                    ticks: {
                        callback: function (value) { return pesoFormatter(value); }
                    }
                }
            }
        }
    });

    // Revenue by Region - Bar
    const locationRevenueLabels = {{ location_revenue_labels|default:'[]'|safe }};
    const locationRevenueValues = {{ location_revenue_values|default:'[]'|safe }};
    createChart('locationRevenueChart', {
        type: 'bar',
        data: {
            labels: locationRevenueLabels,
            datasets: [{
                label: 'Revenue',
                data: locationRevenueValues,
                backgroundColor: chartColors.primary,
                borderColor: chartColors.primary,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return pesoFormatter(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Region' },
                    ticks: { autoSkip: true, maxRotation: 45 }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) { return pesoFormatter(value); }
                    }
                }
            }
        }
    });

    // Revenue by City (Top 10) - Bar
    const cityRevenueLabels = {{ city_revenue_labels|default:'[]'|safe }};
    const cityRevenueValues = {{ city_revenue_values|default:'[]'|safe }};
    createChart('cityRevenueChart', {
        type: 'bar',
        data: {
            labels: cityRevenueLabels,
            datasets: [{
                label: 'Revenue',
                data: cityRevenueValues,
                backgroundColor: chartColors.accent,
                borderColor: chartColors.accent,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return pesoFormatter(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'City' },
                    ticks: { autoSkip: true, maxRotation: 60 }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) { return pesoFormatter(value); }
                    }
                }
            }
        }
    });

    // Revenue by Payment Method - Doughnut
    const paymentMethodValues = {{ payment_method_values|default:'[]'|safe }};
    const paymentMethodLabels = {{ payment_method_labels|default:'[]'|safe }};
    createChart('paymentMethodChart', {
        type: 'doughnut',
        data: {
            labels: paymentMethodLabels,
            datasets: [{
                data: paymentMethodValues,
                backgroundColor: categoricalColors,
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.label || '';
                            return label + ': ' + pesoFormatter(context.parsed);
                        }
                    }
                }
            }
        }
    });

    // Revenue by Patient Type - Bar
    const patientTypeRevenueLabels = {{ patient_type_revenue_labels|default:'[]'|safe }};
    const patientTypeRevenueValues = {{ patient_type_revenue_values|default:'[]'|safe }};
    createChart('patientTypeRevenueChart', {
        type: 'bar',
        data: {
            labels: patientTypeRevenueLabels,
            datasets: [{
                label: 'Revenue',
                data: patientTypeRevenueValues,
                backgroundColor: chartColors.secondary,
                borderColor: chartColors.secondary,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return pesoFormatter(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Patient Type' },
                    ticks: { autoSkip: true, maxRotation: 45 }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) { return pesoFormatter(value); }
                    }
                }
            }
        }
    });

    // Monthly Revenue Trends (Last 12 Months) - Line with Year Navigation
    const monthlyTrendLabels = {{ monthly_trend_labels|default:'[]'|safe }};
    const monthlyTrendValues = {{ monthly_trend_values|default:'[]'|safe }};
    const monthlyNetTrendValues = {{ monthly_net_trend_values|default:'[]'|safe }};

    // Parse the data to organize by year
    const allMonthlyData = {};
    monthlyTrendLabels.forEach((label, index) => {
        const [month, year] = label.split(' ');
        if (!allMonthlyData[year]) {
            allMonthlyData[year] = {
                labels: [],
                totalRevenue: [],
                netRevenue: []
            };
        }
        allMonthlyData[year].labels.push(month);
        allMonthlyData[year].totalRevenue.push(monthlyTrendValues[index]);
        allMonthlyData[year].netRevenue.push(monthlyNetTrendValues[index]);
    });

    // Get available years and set current year
    const availableYears = Object.keys(allMonthlyData).sort((a, b) => b - a);
    let currentTrendYear = availableYears.length > 0 ? availableYears[0] : new Date().getFullYear().toString();

    // Create the chart
    let monthlyTrendChart = null;

    function updateMonthlyTrendChart(year) {
        const canvas = document.getElementById('monthlyTrendChart');
        if (!canvas) return;

        const yearData = allMonthlyData[year];
        const hasData = yearData && yearData.labels.length > 0;

        // Destroy existing chart
        if (monthlyTrendChart) {
            monthlyTrendChart.destroy();
            monthlyTrendChart = null;
        }

        if (!hasData) {
            // Show "No Data" message
            const ctx = canvas.getContext('2d');
            // Get the parent container's dimensions
            const container = canvas.parentElement;
            const containerHeight = container.clientHeight;
            const containerWidth = container.clientWidth;
            
            // Set canvas to match container
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.font = '20px Arial';
            ctx.fillStyle = '#858796';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
            ctx.restore();
            return;
        }
        
        monthlyTrendChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: yearData.labels,
                datasets: [
                    {
                        label: 'Total Revenue',
                        data: yearData.totalRevenue,
                        borderColor: chartColors.primary,
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: chartColors.primary,
                        fill: false
                    },
                    {
                        label: 'Net Revenue',
                        data: yearData.netRevenue,
                        borderColor: chartColors.secondary,
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: chartColors.secondary,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.dataset.label + ': ' + pesoFormatter(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Month' },
                        ticks: { autoSkip: true, maxRotation: 45 }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) { return pesoFormatter(value); }
                        }
                    }
                }
            }
        });
    }

    // Initialize chart with current year
    updateMonthlyTrendChart(currentTrendYear);
    document.getElementById('currentYear').textContent = currentTrendYear;

    // Year navigation button handlers
    document.getElementById('prevYearBtn').addEventListener('click', function() {
        const currentIndex = availableYears.indexOf(currentTrendYear);
        if (currentIndex !== -1 && currentIndex < availableYears.length - 1) {
            // Navigate to previous year in available data
            currentTrendYear = availableYears[currentIndex + 1];
        } else {
            // Go to year before (might not have data)
            currentTrendYear = (parseInt(currentTrendYear) - 1).toString();
        }
        document.getElementById('currentYear').textContent = currentTrendYear;
        updateMonthlyTrendChart(currentTrendYear);
    });

    document.getElementById('nextYearBtn').addEventListener('click', function() {
        const currentIndex = availableYears.indexOf(currentTrendYear);
        if (currentIndex !== -1 && currentIndex > 0) {
            // Navigate to next year in available data
            currentTrendYear = availableYears[currentIndex - 1];
        } else {
            // Go to year after (might not have data)
            currentTrendYear = (parseInt(currentTrendYear) + 1).toString();
        }
        document.getElementById('currentYear').textContent = currentTrendYear;
        updateMonthlyTrendChart(currentTrendYear);
    });
</script>
{% endblock %}
{% endblock %}